<!doctype html><html lang=en data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Event-Driven Architecture with Golang and Message Queues | Buana Coding</title><meta name=description content="Learn how to build scalable event-driven systems using Go and message queues. Master event sourcing, CQRS patterns, and asynchronous communication for resilient distributed applications."><meta name=keywords content="Go,Golang,Event-Driven Architecture,Message Queue,NATS,RabbitMQ,Event Sourcing,CQRS"><link rel=canonical href=https://www.buanacoding.com/2025/09/event-driven-architecture-golang-message-queues.html><link rel=alternate hreflang=en href=https://www.buanacoding.com/2025/09/event-driven-architecture-golang-message-queues.html><meta property="og:type" content="article"><meta property="og:title" content="Event-Driven Architecture with Golang and Message Queues | Buana Coding"><meta property="og:description" content="Learn how to build scalable event-driven systems using Go and message queues. Master event sourcing, CQRS patterns, and asynchronous communication for resilient distributed applications."><meta property="og:url" content="https://www.buanacoding.com/2025/09/event-driven-architecture-golang-message-queues.html"><meta property="og:image" content="https://www.buanacoding.com/images/og-image.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Event-Driven Architecture with Golang and Message Queues | Buana Coding"><meta name=twitter:description content="Learn how to build scalable event-driven systems using Go and message queues. Master event sourcing, CQRS patterns, and asynchronous communication for resilient distributed applications."><meta name=twitter:image content="https://www.buanacoding.com/images/og-image.jpg"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Event-Driven Architecture with Golang and Message Queues | Buana Coding","description":"Learn how to build scalable event-driven systems using Go and message queues. Master event sourcing, CQRS patterns, and asynchronous communication for resilient distributed applications.","inLanguage":"en","datePublished":"2025-09-27T03:00:00\u002b07:00","dateModified":"2025-09-27T03:00:00\u002b07:00","author":{"@type":"Person","name":"Wiku Karno"},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.buanacoding.com\/2025\/09\/event-driven-architecture-golang-message-queues.html"},"image":"https:\/\/www.buanacoding.com\/images\/og-image.jpg","publisher":{"@type":"Organization","name":"Buana Coding"}}</script><link rel=icon href=/favicon.ico type=image/x-icon><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel=stylesheet><link rel=stylesheet href="/style.css?v=1759099665"><link rel=stylesheet href="/css/overrides.css?v=1759099665"><link rel=stylesheet href="/css/syntax.css?v=1759099665"><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("consent","default",{ad_storage:"granted",ad_user_data:"granted",ad_personalization:"granted",analytics_storage:"granted"})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0EN9J73FXF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0EN9J73FXF")</script><script async src="https://fundingchoicesmessages.google.com/i/pub-3149036684216973?ers=1"></script><script>(function(){function e(){if(!window.frames.googlefcPresent)if(document.body){const e=document.createElement("iframe");e.style="width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;",e.style.display="none",e.name="googlefcPresent",document.body.appendChild(e)}else setTimeout(e,0)}e()})()</script><script>(function(){"use strict";function at(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}Z=typeof Object.defineProperties=="function"?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype?e:(e[t]=n.value,e)};function Ge(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var t,n=0;n<e.length;++n)if(t=e[n],t&&t.Math==Math)return t;throw Error("Cannot find global object")}Pe=Ge(this);function c(e,t){if(t)a:{var n,o,s=Pe;e=e.split(".");for(n=0;n<e.length-1;n++){if(o=e[n],!(o in s))break a;s=s[o]}e=e[e.length-1],n=s[e],t=t(n),t!=n&&t!=null&&Z(s,e,{configurable:!0,writable:!0,value:t})}}function G(e){return e.raw=e}function b(e){var t=typeof Symbol!="undefined"&&Symbol.iterator&&e[Symbol.iterator];if(t)return t.call(e);if(typeof e.length=="number")return{next:at(e)};throw Error(String(e)+" is not an iterable or ArrayLike")}function Xe(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}if(Se=typeof Object.create=="function"?Object.create:function(e){function t(){}return t.prototype=e,new t},typeof Object.setPrototypeOf=="function")R=Object.setPrototypeOf;else{a:{we={a:!0},V={};try{V.__proto__=we,P=V.a;break a}catch{}P=!1}R=P?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}W=R;function K(e,t){if(e.prototype=Se(t.prototype),e.prototype.constructor=e,W)W(e,t);else for(n in t)if(n!="prototype")if(Object.defineProperties){var n,s=Object.getOwnPropertyDescriptor(t,n);s&&Object.defineProperty(e,n,s)}else e[n]=t[n];e.A=t.prototype}function Q(){for(var t=Number(this),n=[],e=t;e<arguments.length;e++)n[e-t]=arguments[e];return n}c("Object.is",function(e){return e||function(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}}),c("Array.prototype.includes",function(e){return e||function(e,t){var s,o,n=this;n instanceof String&&(n=String(n)),s=n.length,t=t||0;for(t<0&&(t=Math.max(t+s,0));t<s;t++)if(o=n[t],o===e||Object.is(o,e))return!0;return!1}}),c("String.prototype.includes",function(e){return e||function(e,t){if(this==null)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(e instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return this.indexOf(e,t||0)!==-1}}),c("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991}),c("Number.isFinite",function(e){return e||function(e){return typeof e=="number"&&!isNaN(e)&&e!==1/0&&e!==-(1/0)}}),c("Number.isInteger",function(e){return e||function(e){return!!Number.isFinite(e)&&e===Math.floor(e)}}),c("Number.isSafeInteger",function(e){return e||function(e){return Number.isInteger(e)&&(e<0?-e:e)<=Number.MAX_SAFE_INTEGER}}),c("Math.trunc",function(e){return e||function(e){if(e=Number(e),isNaN(e)||e===1/0||e===-(1/0)||e===0)return e;var t=Math.floor(e<0?-e:e);return e<0?-t:t}}),e=this||self;function _(t,n){a:{for(var s=["CLOSURE_FLAGS"],o=e,i=0;i<s.length;i++)if(o=o[s[i]],o==null){s=null;break a}s=o}return t=s&&s[t],t??n}function q(e){return e}function ct(t){e.setTimeout(function(){throw t},0)}var ae=_(610401301,!1),ot=_(188588736,!0),et=_(645172343,_(1,!0)),Oe=e.navigator,O=Oe?Oe.userAgentData||null:null;function L(e){return!!ae&&!!O&&O.brands.some(function(t){return(t=t.brand)&&t.indexOf(e)!=-1})}function s(t){var n;a:{if((n=e.navigator)&&(n=n.userAgent))break a;n=""}return n.indexOf(t)!=-1}function r(){return!!ae&&!!O&&O.brands.length>0}function F(){return r()?L("Chromium"):(s("Chrome")||s("CriOS"))&&!(r()?0:s("Edge"))||s("Silk")}be=!r()&&(s("Trident")||s("MSIE")),!s("Android")||F(),F(),s("Safari")&&(F()||(r()?0:s("Coast"))||(r()?0:s("Opera"))||(r()?0:s("Edge"))||(r()?L("Microsoft Edge"):s("Edg/"))||r()&&L("Opera")),M={},v=null,T=typeof Uint8Array!="undefined",He=!be&&typeof btoa=="function";function N(){return typeof BigInt=="function"}g=typeof Symbol=="function"&&typeof Symbol()=="symbol";function xe(e){return typeof Symbol=="function"&&typeof Symbol()=="symbol"?Symbol():e}var Z,Pe,Se,t,R,P,we,e,n,O,V,W,be,v,M,T,He,Te,m,g,X,oe,C,E,Ae,j,Fe,le,re,ie,x=xe(),H=xe("2ex"),ye=g?function(e,t){e[x]|=t}:function(e,t){e.g!==0[0]?e.g|=t:Object.defineProperties(e,{g:{value:t,configurable:!0,writable:!0,enumerable:!1}})},h=g?function(e){return e[x]|0}:function(e){return e.g|0},d=g?function(e){return e[x]}:function(e){return e.g},l=g?function(e,t){e[x]=t}:function(e,t){e.g!==0[0]?e.g=t:Object.defineProperties(e,{g:{value:t,configurable:!0,writable:!0,enumerable:!1}})};function it(e,t){l(t,(e|0)&-14591)}function U(e,t){l(t,(e|34)&-14557)}m={},X={};function Ie(e){return!(!e||typeof e!="object"||e.g!==X)}function S(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&e.constructor===Object}function y(e,t,n){if(!Array.isArray(e)||e.length)return!1;var s=h(e);return!!(s&1)||!!(t&&(Array.isArray(t)?t.includes(n):t.has(n)))&&(l(e,s|1),!0)}t=0,n=0;function J(e){var s=e>>>0;t=s,n=(e-s)/4294967296>>>0}function ee(e){if(e<0){J(-e);var s=b(A(t,n));e=s.next().value,s=s.next().value,t=e>>>0,n=s>>>0}else J(e)}function te(e,t){if(t>>>=0,e>>>=0,t<=2097151)var n=""+(4294967296*t+e);else N()?n=""+(BigInt(t)<<BigInt(32)|BigInt(e)):(n=(e>>>24|t<<8)&16777215,t=t>>16&65535,e=(e&16777215)+n*6777216+t*6710656,n+=t*8147497,t*=2,e>=1e7&&(n+=e/1e7>>>0,e%=1e7),n>=1e7&&(t+=n/1e7>>>0,n%=1e7),n=t+ne(n)+ne(e));return n}function ne(e){return e=String(e),"0000000".slice(e.length)+e}function A(e,t){return t=~t,e?e=~e+1:t+=1,[e,t]}oe=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;function $(e,t){return E=t,e=new e(t),E=0[0],e}function k(e,t,n){if(e==null&&(e=E),E=0[0],e==null){var o,i,s=96;n?(e=[n],s|=512):e=[],t&&(s=s&-16760833|(t&1023)<<14)}else{if(!Array.isArray(e))throw Error("narr");if(s=h(e),s&2048)throw Error("farr");if(s&64)return e;if(s|=64,n&&(s|=512,n!==e[0]))throw Error("mid");a:{if(n=e,o=n.length,o&&(i=o-1,S(n[i]))){if(s|=256,t=i-(+!!(s&512)-1),t>=1024)throw Error("pvtlmt");s=s&-16760833|(t&1023)<<14;break a}if(t){if(t=Math.max(t,o-(+!!(s&512)-1)),t>1024)throw Error("spvt");s=s&-16760833|(t&1023)<<14}}}return l(e,s),e}function st(e){switch(typeof e){case"number":return isFinite(e)?e:String(e);case"boolean":return e?1:0;case"object":if(e)if(Array.isArray(e)){if(y(e,0[0],0))return}else if(T&&e!=null&&e instanceof Uint8Array){if(He){for(var n,o,i,a,c,l,t="",s=0,r=e.length-10240;s<r;)t+=String.fromCharCode.apply(null,e.subarray(s,s+=10240));t+=String.fromCharCode.apply(null,s?e.subarray(s):e),e=btoa(t)}else{if(t===0[0]&&(t=0),!v){v={},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),r=["+/=","+/","-_=","-_.","-_"];for(a=0;a<5;a++){n=s.concat(r[a].split("")),M[a]=n;for(o=0;o<n.length;o++)i=n[o],v[i]===0[0]&&(v[i]=o)}}t=M[t],s=Array(Math.floor(e.length/3)),r=t[64]||"";for(a=n=0;n<e.length-2;n+=3)c=e[n],l=e[n+1],i=e[n+2],o=t[c>>2],c=t[(c&3)<<4|l>>4],l=t[(l&15)<<2|i>>6],i=t[i&63],s[a++]=o+c+l+i;switch(o=0,i=r,e.length-n){case 2:o=e[n+1],i=t[(o&15)<<2]||r;case 1:e=e[n],s[a]=t[e>>2]+t[(e&3)<<4|o>>4]+i+r}e=s.join("")}return e}}return e}function nt(e,t,n){e=Array.prototype.slice.call(e);var i,o=e.length,s=t&256?e[o-1]:0[0];o+=s?-1:0;for(t=t&512?1:0;t<o;t++)e[t]=n(e[t]);if(s){t=e[t]={};for(i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=n(s[i]))}return e}function de(e,t,n,s,o){if(e!=null){if(Array.isArray(e))e=y(e,0[0],0)?0[0]:o&&h(e)&2?e:B(e,t,n,s!==0[0],o);else if(S(e)){var i,a={};for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&(a[i]=de(e[i],t,n,s,o));e=a}else e=t(e,s);return e}}function B(e,t,n,s,o){var i,a=s||n?h(e):0;s=s?!!(a&32):0[0],e=Array.prototype.slice.call(e);for(i=0;i<e.length;i++)e[i]=de(e[i],t,n,s,o);return n&&n(a,e),e}function We(e){return e.s===m?e.toJSON():st(e)}function me(e,t,n){if(n=n===0[0]?U:n,e!=null){if(T&&e instanceof Uint8Array)return t?e:new Uint8Array(e);if(Array.isArray(e)){var s=h(e);return s&2?e:(t&&(t=s===0||!!(s&32)&&!(s&64||!(s&16))),t?(l(e,(s|34)&-12293),e):B(e,me,s&4?U:n,!0,!0))}return e.s===m&&(n=e.h,s=d(n),e=s&2?e:$(e.constructor,fe(n,s,!0))),e}}function fe(e,t,n){var s=n||t&2?U:it,o=!!(t&32);return e=nt(e,t,function(e){return me(e,o,s)}),ye(e,32|(n?2:0)),e}function pe(e,t){return e=e.h,ve(e,d(e),t)}function ge(e,t,n,s){if(t=s+(+!!(t&512)-1),!(t<0||t>=e.length||t>=n))return e[t]}function ve(e,t,n,s){if(n===-1)return null;var o,a,i=t>>14&1023||536870912;if(n>=i){if(t&256)return e[e.length-1][n]}else return a=e.length,s&&t&256&&(s=e[a-1][n],s!=null)?(ge(e,t,i,n)&&H!=null&&(e=(o=Te)!=null?o:Te={},o=e[H]||0,o>=4||(e[H]=o+1,o=Error(),o.__closure__error__context__984382||(o.__closure__error__context__984382={}),o.__closure__error__context__984382.severity="incident",ct(o))),s):ge(e,t,i,n)}function Y(e,t,n,s,o){var i,a=t>>14&1023||536870912;if(n>=a||o&&!et){if(i=t,t&256)o=e[e.length-1];else{if(s==null)return;o=e[a+(+!!(t&512)-1)]={},i|=256}o[n]=s,n<a&&(e[n+(+!!(t&512)-1)]=0[0]),i!==t&&l(e,i)}else e[n+(+!!(t&512)-1)]=s,t&256&&(e=e[e.length-1],n in e&&delete e[n])}function je(e,t){var a,r,s=he,c=c!==0[0]&&c,o=e.h,i=d(o),n=ve(o,i,t,c);return n!=null&&typeof n=="object"&&n.s===m?s=n:Array.isArray(n)?(a=h(n),r=a,r===0&&(r|=i&32),r|=i&2,r!==a&&l(n,r),s=new s(n)):s=0[0],s!==n&&s!=null&&Y(o,i,t,s,c),o=s,o==null?o:(e=e.h,i=d(e),i&2||(n=o,s=n.h,a=d(s),n=a&2?$(n.constructor,fe(s,a,!1)):n,n!==o&&(o=n,Y(e,i,t,o,c))),o)}function I(e,t){return e=pe(e,t),e==null||typeof e=="string"?e:0[0]}function _e(e,s){if(i=i===0[0]?0:i,e=pe(e,s),e!=null)if(s=typeof e,s==="number"?Number.isFinite(e):s!=="string"?0:oe.test(e)){if(typeof e=="number")e=e|0,!Number.isSafeInteger(e)&&(ee(e),s=t,o=n,(e=o&2147483648)&&(s=~s+1>>>0,o=~o>>>0,s==0&&(o=o+1>>>0)),s=o*4294967296+(s>>>0),e=e?-s:s);else if(s=Number(e)|0,Number.isSafeInteger(s))e=String(s);else if(s=e.indexOf("."),s!==-1&&(e=e.substring(0,s)),!(e[0]==="-"?e.length<20||e.length===20&&Number(e.substring(0,7))>-922337:e.length<19||e.length===19&&Number(e.substring(0,6))<922337)){if(e.length<16)ee(Number(e));else if(N())e=BigInt(e),t=Number(e&BigInt(4294967295))>>>0,n=Number(e>>BigInt(32)&BigInt(4294967295));else{s=+(e[0]==="-"),n=t=0,o=e.length;for(var o,i,a=s,r=(o-s)%6+s;r<=o;a=r,r+=6)a=Number(e.slice(a,r)),n*=1e6,t=t*1e6+a,t>=4294967296&&(n+=t/4294967296|0,n>>>=0,t>>>=0);s&&(s=b(A(t,n)),e=s.next().value,s=s.next().value,t=e,n=s)}e=t,s=n,s&2147483648?N()?e=""+(BigInt(s|0)<<BigInt(32)|BigInt(e>>>0)):(s=b(A(e,s)),e=s.next().value,s=s.next().value,e="-"+te(e,s)):e=te(e,s)}}else e=0[0];return e??i}function a(e,t){var n=n===0[0]?"":n;return e=I(e,t),e??n}function u(e,t,n){this.h=k(e,t,n)}u.prototype.toJSON=function(){return Ce(this)},u.prototype.s=m,u.prototype.toString=function(){try{return C=!0,Ce(this).toString()}finally{C=!1}};function Ce(e){if(a=C?e.h:B(e.h,We,0[0],0[0],!1),m=!C,h=ot?0[0]:e.constructor.v,l=d(m?e.h:a),e=a.length){var t,n,s,o,i,a,l,u,h,m,f,c=a[e-1],r=S(c);if(r?e--:c=0[0],l=+!!(l&512)-1,i=a,r){b:{if(s=c,n={},r=!1,s)for(t in s)Object.prototype.hasOwnProperty.call(s,t)&&(isNaN(+t)?n[t]=s[t]:(o=s[t],Array.isArray(o)&&(y(o,h,+t)||Ie(o)&&o.size===0)&&(o=null),o==null&&(r=!0),o!=null&&(n[t]=o)));if(r){for(u in n)break b;n=null}else n=s}s=n==null?c!=null:n!==c}for(;e>0;e--){if(u=e-1,t=i[u],u-=l,!(t==null||y(t,h,u)||Ie(t)&&t.size===0))break;f=!0}(i!==a||s||f)&&(m?(f||s||n)&&(i.length=e):i=Array.prototype.slice.call(i,0,e),n&&i.push(n)),a=i}return a}function Ee(e){return function(t){if(t==null||t=="")t=new e;else{if(t=JSON.parse(t),!Array.isArray(t))throw Error("dnarr");ye(t,32),t=$(e,t)}return t}}function ke(e){this.h=k(e)}K(ke,u),Ae=Ee(ke);function w(e){this.g=e}w.prototype.toString=function(){return this.g+""},Fe={};function D(t){if(j===0[0]){var n=null,s=e.trustedTypes;if(s&&s.createPolicy){try{n=s.createPolicy("goog#html",{createHTML:q,createScript:q,createScriptURL:q})}catch(t){e.console&&e.console.error(t.message)}j=n}else j=n}return t=(n=j)?n.createScriptURL(t):t,new w(t,Fe)}function ze(e){if(t=Q.apply(1,arguments),t.length===0)return D(e[0]);for(var t,s=e[0],n=0;n<t.length;n++)s+=encodeURIComponent(t[n])+e[n+1];return D(s)}function Ye(e,t){e.src=t instanceof w&&t.constructor===w?t.g:"type_error:TrustedResourceUrl";var n,s;(n=(t=(s=(n=(e.ownerDocument&&e.ownerDocument.defaultView||window).document).querySelector)==null?0[0]:s.call(n,"script[nonce]"))?t.nonce||t.getAttribute("nonce")||"":"")&&e.setAttribute("nonce",n)}function Ne(){return Math.floor(Math.random()*2147483648).toString(36)+Math.abs(Math.floor(Math.random()*2147483648)^Date.now()).toString(36)}function Le(e,t){return t=String(t),e.contentType==="application/xhtml+xml"&&(t=t.toLowerCase()),e.createElement(t)}function Re(t){this.g=t||e.document||document}function qe(e){return e=e===0[0]?document:e,e.createElement("script")}function z(e,t,n,s,o,i){try{var r=e.g,a=qe(r);a.async=!0,Ye(a,t),r.head.appendChild(a),a.addEventListener("load",function(){o(),s&&r.head.removeChild(a)}),a.addEventListener("error",function(){n>0?z(e,t,n-1,s,o,i):(s&&r.head.removeChild(a),i())})}catch{i()}}var Ke=e.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),Ue=e.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),Je=e.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu");function tt(e,t,n){this.i=e,this.u=t,this.o=n,this.g=null,this.j=[],this.m=!1,this.l=new Re(this.i)}function Ve(t){if(t.i.body&&!t.m){var n=function(){Be(t),e.setTimeout(function(){Me(t,3)},50)};z(t.l,t.u,2,!0,function(){e[t.o]||n()},n),t.m=!0}}function Be(e){for(var s,a,r,c,t=o(1,5),n=0;n<t;n++)s=i(e),e.i.body.appendChild(s),e.j.push(s);t=i(e),t.style.bottom="0",t.style.left="0",t.style.position="fixed",t.style.width=o(100,110).toString()+"%",t.style.zIndex=o(2147483544,2147483644).toString(),t.style.backgroundColor=De(249,259,242,252,219,229),t.style.boxShadow="0 0 12px #888",t.style.color=De(0,10,0,10,0,10),t.style.display="flex",t.style.justifyContent="center",t.style.fontFamily="Roboto, Arial",n=i(e),n.style.width=o(80,85).toString()+"%",n.style.maxWidth=o(750,775).toString()+"px",n.style.margin="24px",n.style.display="flex",n.style.alignItems="flex-start",n.style.justifyContent="center",s=Le(e.l.g,"IMG"),s.className=Ne(),s.src=Ke,s.alt="Warning icon",s.style.height="24px",s.style.width="24px",s.style.paddingRight="16px",a=i(e),r=i(e),r.style.fontWeight="bold",r.textContent=Ue,c=i(e),c.textContent=Je,p(e,a,r),p(e,a,c),p(e,n,s),p(e,n,a),p(e,t,n),e.g=t,e.i.body.appendChild(e.g),t=o(1,5);for(n=0;n<t;n++)s=i(e),e.i.body.appendChild(s),e.j.push(s)}function p(e,t,n){for(var r,s=o(1,5),a=0;a<s;a++)r=i(e),t.appendChild(r);t.appendChild(n),n=o(1,5);for(s=0;s<n;s++)a=i(e),t.appendChild(a)}function o(e,t){return Math.floor(e+Math.random()*(t-e))}function De(e,t,n,s,i,a){return"rgb("+o(Math.max(e,0),Math.min(t,255)).toString()+","+o(Math.max(n,0),Math.min(s,255)).toString()+","+o(Math.max(i,0),Math.min(a,255)).toString()+")"}function i(e){return e=Le(e.l.g,"DIV"),e.className=Ne(),e}function Me(t,n){n<=0||t.g!=null&&t.g.offsetHeight!==0&&t.g.offsetWidth!==0||(Qe(t),Be(t),e.setTimeout(function(){Me(t,n-1)},50))}function Qe(e){for(var n=b(e.j),t=n.next();!t.done;t=n.next())(t=t.value)&&t.parentNode&&t.parentNode.removeChild(t);e.j=[],(n=e.g)&&n.parentNode&&n.parentNode.removeChild(n),e.g=null}function Ze(t,n,s,o,i){function r(t){document.body?c(document.body):t>0?e.setTimeout(function(){r(t-1)},i):n()}function c(s){s.appendChild(a),e.setTimeout(function(){a?(a.offsetHeight!==0&&a.offsetWidth!==0?n():t(),a.parentNode&&a.parentNode.removeChild(a)):t()},o)}var a=$e(s);r(3)}function $e(e){var t=document.createElement("div");return t.className=e,t.style.width="1px",t.style.height="1px",t.style.position="absolute",t.style.left="-10000px",t.style.top="-10000px",t.style.zIndex="-10000",t}function he(e){this.h=k(e)}K(he,u);function ue(e){this.h=k(e)}K(ue,u),le=Ee(ue);function ce(e){if(!e)return null;e=I(e,4);var t;return e==null?t=null:t=D(e),t}re=G([""]),ie=G([""]);function se(e,t){this.m=e,this.o=new Re(e.document),this.g=t,this.j=a(this.g,1),this.u=ce(je(this.g,2))||ze(re),this.i=!1,t=ce(je(this.g,13))||ze(ie),this.l=new tt(e.document,t,a(this.g,12))}se.prototype.start=function(){rt(this)};function rt(t){lt(t),z(t.o,t.u,3,!1,function(){a:{var o,n=t.j,s=e.btoa(n);if(s=e[s]){try{o=Ae(e.atob(s))}catch{n=!1;break a}n=n===I(o,1)}else n=!1}n?f(t,a(t.g,14)):(f(t,a(t.g,8)),Ve(t.l))},function(){Ze(function(){f(t,a(t.g,7)),Ve(t.l)},function(){return f(t,a(t.g,6))},a(t.g,9),_e(t.g,10),_e(t.g,11))})}function f(e,t){e.i||(e.i=!0,e=new e.m.XMLHttpRequest,e.open("GET",t,!0),e.send())}function lt(t){var n=e.btoa(t.j);t.m[n]&&f(t,a(t.g,5))}(function(t,n){e[t]=function(){var s=Q.apply(0,arguments);e[t]=function(){},n.call.apply(n,[null].concat(s instanceof Array?s:Xe(b(s))))}})("__h82AlnkH6D91__",function(e){typeof window.atob=="function"&&new se(window,le(window.atob(e))).start()})}).call(this),window.__h82AlnkH6D91__("WyJwdWItMzE0OTAzNjY4NDIxNjk3MyIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi0zMTQ5MDM2Njg0MjE2OTczIl0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hXRW1tb2ZrZGEwZHlSNkcxMkdNSnNEZDF5UFF4a3FSYS11R2NVem9LZHh6NGFxNndzZm5DN3VPekxfWmljWUZvSW5iYnNKRGtFUUU1a1RUNFFGb25MMF9nXHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFZVeXNCQ3NSc2llS3ExOENZVDNibVVqbFREbTVKM01FR1BSdUVoRjFsV3c3UjVNdGRwWnhNM2hJQm1tMnZhbjNmVWxZcVNLSnoycE5xMWNSTUJZYUxfLXdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFVvQ2JlQlRkS2gzZmU0NnB1VERhek9PdHN0b0p3NjhKUU5SOGQ1OFgwWm9QRlV0LUZPUm1HU1ZJajM2WXQwQjU3c0t1bUFmcjFNWU5JV3U3U3JXNi1EQkFcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFdORXhuRXA0STJueGlBNXdiejVRMDZzT0Njek53bFltRXo4cWhOY0sxZzd2N1UwR2ZVZ0hJOFlPeWk1Qms2NGljWTNzU3BMRE9IZ3pSNTg0VlA5ak5sZmdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUTXhORGt3TXpZMk9EUXlNVFk1TnpNXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi0zMTQ5MDM2Njg0MjE2OTczLmpzP3VzcXBcdTAwM2RDQWMiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4VmpzRmdxZHhwME1yZFNEMjF6Q2l2TkR3cjZvM0FfNEQyYVlaRUJJZXZNSmN1eUVvNmRmX29XMUNiZFVRdVR1WW52cGZUdWhteS1NTXZfcGlqVlB0NUQxZ1x1MDAzZFx1MDAzZCJd")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3149036684216973" crossorigin=anonymous></script></head><body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen flex flex-col"><header class="bg-[#0f7ea9] dark:bg-[#094d66] text-white shadow"><div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"><h1 class="text-2xl font-extrabold tracking-wide"><a href=/ class=hover:opacity-90>BUANACODING</a></h1><nav class="hidden md:flex items-center space-x-6 font-semibold uppercase tracking-wide"><a href=/tags/general class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">General
</a><a href=/tags/go class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Go
</a><a href=/tags/laravel class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Laravel
</a><a href=/tags/linux class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Linux
</a><a href=/tags/python class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Python
</a><a href=/tags/security class="no-underline hover:text-cyan-300 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Security</a><div class="hidden md:flex items-center"><div class="flex border border-white/30 rounded overflow-hidden text-xs font-medium"><a href=/2025/09/event-driven-architecture-golang-message-queues.html data-lang=en data-has-trans=true class="js-lang-link px-2 py-1 bg-white/20 text-white">EN
</a><a href=/id/ data-lang=id data-has-trans=false class="js-lang-link px-2 py-1 bg-transparent hover:bg-white/10 text-white/80">ID</a></div></div><button id=openSearchModal class="text-white transition duration-300 cursor-pointer focus:outline-none dark:hover:text-[#0f7ea9] hover:text-cyan-300" aria-label=Search>
<i data-feather=search class="w-5 h-5"></i>
</button>
<button id=theme-toggle class="ml-2 text-white hover:text-yellow-300 transition duration-300 focus:outline-none cursor-pointer" aria-label="Toggle Dark Mode">
<i id=icon-sun data-feather=sun class="w-5 h-5 hidden"></i>
<i id=icon-moon data-feather=moon class="w-5 h-5"></i></button></nav><button id=menu-toggle class="md:hidden text-2xl focus:outline-none">
â˜°</button></div><div id=mobile-menu class="hidden md:hidden px-4 pb-4 space-y-2"><a href=/tags/general class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">General
</a><a href=/tags/go class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Go
</a><a href=/tags/laravel class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Laravel
</a><a href=/tags/linux class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Linux
</a><a href=/tags/python class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Python
</a><a href=/tags/security class="block no-underline hover:text-cyan-500 dark:hover:text-[#0f7ea9] transition font-medium text-sm capitalize">Security</a><div class="mt-8 space-y-6"><button id=openSearchModalMobile class="w-full text-left text-white hover:text-cyan-300 transition duration-300 flex items-center gap-4 py-2" aria-label=Search>
<i data-feather=search class="w-5 h-5"></i>
<span class="text-sm font-medium">Search</span></button><div class="flex items-center justify-between py-2"><div class="flex items-center gap-4"><i data-feather=globe class="w-5 h-5 text-white/80"></i>
<span class="text-sm font-medium text-white">Language</span></div><div class="flex text-xs"><a href=/2025/09/event-driven-architecture-golang-message-queues.html data-lang=en data-has-trans=true class="js-lang-link px-3 py-1.5 text-white font-medium">EN
</a><a href=/id/ data-lang=id data-has-trans=false class="js-lang-link px-3 py-1.5 text-white/60 hover:text-white">ID</a></div></div><button id=theme-toggle-mobile class="w-full text-left text-white hover:text-cyan-300 transition duration-300 flex items-center gap-4 py-2" aria-label="Toggle Dark Mode">
<i id=icon-sun-mobile data-feather=sun class="w-5 h-5 hidden"></i>
<i id=icon-moon-mobile data-feather=moon class="w-5 h-5"></i>
<span class="text-sm font-medium">Theme</span></button></div></div></header><div class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 py-2"><div class="max-w-7xl mx-auto px-4"><div class="text-center mb-2"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><div class="flex justify-center"><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-3149036684216973 data-ad-slot=9616560861 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div><div id=searchModal class="fixed inset-0 z-50 hidden flex justify-center items-center bg-black/30 dark:bg-black/60 backdrop-blur-md p-4"><div class="bg-white dark:bg-[#1f2937] rounded-xl shadow-2xl w-full max-w-xl p-6 relative"><button id=closeSearchModal class="absolute -top-4 -right-4 bg-white dark:bg-[#374151] rounded-full p-1 shadow hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-200 ease-in-out transform hover:scale-110">
<i data-feather=x class="w-5 h-5 text-gray-600 dark:text-white hover:text-red-500"></i>
</button>
<input type=text id=searchBox placeholder="Search articles..." class="w-full px-4 py-3 mb-4 border border-cyan-400 text-gray-800 dark:text-white dark:bg-[#374151] placeholder-gray-400 dark:placeholder-gray-400 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"><div id=searchAdBanner class="mt-4 mb-8 hidden"><div class="text-center mb-2"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><ins class="adsbygoogle search-results-ad" style=display:block;min-height:100px;max-width:100% data-ad-client=ca-pub-3149036684216973 data-ad-slot=3879195288 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><style>#searchAdBanner{transition:opacity .3s ease-in-out,transform .3s ease-in-out}#searchAdBanner.show{display:block!important;opacity:1;transform:translateY(0)}#searchAdBanner.hide{opacity:0;transform:translateY(-10px)}.search-results-ad{max-height:100px;overflow:hidden}</style><ul id=results class="bg-white dark:bg-[#1f2937] rounded-lg shadow max-h-60 overflow-y-auto divide-y divide-gray-200 dark:divide-gray-600"></ul></div></div><main class="flex-1 w-full"><div class="max-w-7xl mx-auto py-8 px-4"><div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 py-8"><article class="prose prose-blue dark:prose-invert lg:col-span-2"><nav class="text-sm text-gray-600 dark:text-gray-300 mb-4"><a href=/ class="text-gray-600 dark:text-gray-300 hover:text-[#0f7ea9] no-underline">Home</a>
<span class="mx-2 text-gray-400 dark:text-gray-500">/</span>
<a href=/tags/go class="text-gray-600 dark:text-gray-300 hover:text-[#0f7ea9] no-underline">#Go</a></nav><h1>Event-Driven Architecture with Golang and Message Queues</h1><div class="flex items-center gap-4 my-4 py-3 border-b border-gray-200 dark:border-gray-700"><span class="text-sm text-gray-500 dark:text-gray-400 font-medium mr-2">Share:</span>
<a href="https://twitter.com/intent/tweet?text=Event-Driven+Architecture+with+Golang+and+Message+Queues&url=https%3A%2F%2Fwww.buanacoding.com%2F2025%2F09%2Fevent-driven-architecture-golang-message-queues.html&via=buanacoding" target=_blank rel=noopener class="p-2 text-gray-500 dark:text-gray-400 hover:text-black hover:bg-gray-100 dark:hover:text-white dark:hover:bg-gray-700 rounded-full transition-all duration-200" title="Share on Twitter"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.buanacoding.com%2F2025%2F09%2Fevent-driven-architecture-golang-message-queues.html" target=_blank rel=noopener class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:text-blue-400 dark:hover:bg-blue-900/20 rounded-full transition-all duration-200" title="Share on Facebook"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.buanacoding.com%2F2025%2F09%2Fevent-driven-architecture-golang-message-queues.html" target=_blank rel=noopener class="p-2 text-gray-500 dark:text-gray-400 hover:text-blue-700 hover:bg-blue-50 dark:hover:text-blue-400 dark:hover:bg-blue-900/20 rounded-full transition-all duration-200" title="Share on LinkedIn"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://wa.me/?text=Event-Driven+Architecture+with+Golang+and+Message+Queues%20https%3A%2F%2Fwww.buanacoding.com%2F2025%2F09%2Fevent-driven-architecture-golang-message-queues.html" target=_blank rel=noopener class="p-2 text-gray-500 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:text-green-400 dark:hover:bg-green-900/20 rounded-full transition-all duration-200" title="Share on WhatsApp"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.484 3.488"/></svg>
</a><button onclick='copyLinkHeader("https://www.buanacoding.com/2025/09/event-driven-architecture-golang-message-queues.html")' class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-800 hover:bg-gray-100 dark:hover:text-gray-200 dark:hover:bg-gray-700 rounded-full transition-all duration-200" title="Copy Link">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
</button>
<span id=copy-header-success class="hidden text-xs text-green-600 dark:text-green-400 font-medium">Copied!</span></div><script>function copyLinkHeader(e){navigator.clipboard.writeText(e).then(function(){showHeaderSuccess()}).catch(function(){const n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),showHeaderSuccess()})}function showHeaderSuccess(){const e=document.getElementById("copy-header-success");e.classList.remove("hidden"),setTimeout(function(){e.classList.add("hidden")},2e3)}</script><p>Traditional request-response architectures work well for simple applications, but as systems grow in complexity and scale, they often become bottlenecks. Event-driven architecture gives you a better way to build systems by letting components talk to each other through messages instead of direct calls. When combined with Go&rsquo;s excellent concurrency model and robust ecosystem, event-driven systems become powerful tools for building scalable, resilient applications.</p><p>In this guide, you&rsquo;ll learn how to build event-driven systems using Go and message queues that actually work in production. We&rsquo;ll explore event sourcing patterns, CQRS implementation, and practical strategies for building systems that can handle high throughput while maintaining data consistency and system reliability.</p><h2 id=understanding-event-driven-architecture>Understanding Event-Driven Architecture</h2><p>Event-driven architecture is built around three main ideas: creating events when things happen, detecting those events, and doing something useful with them. An event represents something significant that happened in your system - a user registered, an order was placed, or a payment was processed. Unlike traditional synchronous architectures where components directly call each other, event-driven systems use events as the primary means of communication.</p><div class="my-8 flex justify-center"><div class="w-full max-w-2xl"><div class="text-center mb-2"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-3149036684216973 data-ad-slot=2492895769></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><p>Every event-driven system has three main parts: services that create events when something important happens, services that listen for those events and do work, and a message system that gets events from creators to listeners reliably.</p><p>This approach has some real benefits. Your services don&rsquo;t need to know about each other directly, which makes the system easier to maintain and lets you scale different parts independently. The asynchronous nature improves performance since operations don&rsquo;t block waiting for responses. Additionally, the system becomes more resilient because failures in one component don&rsquo;t immediately cascade to others.</p><p>But event-driven systems aren&rsquo;t all sunshine and rainbows. Since things happen asynchronously, your data might not be immediately consistent everywhere. Debugging becomes more challenging because request flows span multiple components. Message ordering and delivery guarantees require careful consideration to ensure your system behaves correctly.</p><h2 id=choosing-the-right-message-queue-system>Choosing the Right Message Queue System</h2><p>The message queue is the heart of your event-driven system. Each option gives you different trade-offs between speed, reliability, and how hard it is to run in production. Let&rsquo;s examine the most popular options for Go applications.</p><p><strong>NATS</strong> provides lightweight, high-performance messaging with excellent Go support. It&rsquo;s particularly well-suited for microservices communication and real-time applications. NATS offers different messaging patterns including publish-subscribe, request-reply, and queuing, with built-in load balancing and fault tolerance.</p><p><strong>RabbitMQ</strong> offers robust features including message persistence, complex routing, and guaranteed delivery. It supports multiple messaging patterns and provides excellent tooling for monitoring and management. RabbitMQ works well for enterprise applications that need reliable message delivery guarantees.</p><p><strong>Apache Kafka</strong> excels at high-throughput scenarios and provides excellent durability through its distributed log architecture. Kafka is ideal for event sourcing implementations and systems that need to replay events. However, it has higher operational complexity compared to simpler solutions.</p><p>For this guide, we&rsquo;ll focus primarily on NATS and RabbitMQ, as they provide good balance between features and simplicity for most Go applications.</p><h2 id=implementing-event-driven-patterns-with-nats>Implementing Event-Driven Patterns with NATS</h2><p>We&rsquo;ll build a real-world example using NATS - an e-commerce order processing system that shows you the patterns you&rsquo;ll actually use in production.</p><p>First, install and set up NATS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Install NATS server</span>
</span></span><span class=line><span class=cl>go get github.com/nats-io/nats-server/v2
</span></span><span class=line><span class=cl>go get github.com/nats-io/nats.go
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start NATS server (for development)</span>
</span></span><span class=line><span class=cl>nats-server
</span></span></code></pre></div><p>Create the basic event infrastructure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/events/event.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;encoding/json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Event represents a domain event in our system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Event</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>        </span><span class=kt>string</span><span class=w>                 </span><span class=s>`json:&#34;id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Type</span><span class=w>      </span><span class=kt>string</span><span class=w>                 </span><span class=s>`json:&#34;type&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Source</span><span class=w>    </span><span class=kt>string</span><span class=w>                 </span><span class=s>`json:&#34;source&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Data</span><span class=w>      </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span><span class=w> </span><span class=s>`json:&#34;data&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Version</span><span class=w>   </span><span class=kt>string</span><span class=w>                 </span><span class=s>`json:&#34;version&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Timestamp</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>              </span><span class=s>`json:&#34;timestamp&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// NewEvent creates a new event with required metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewEvent</span><span class=p>(</span><span class=nx>eventType</span><span class=p>,</span><span class=w> </span><span class=nx>source</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Event</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>        </span><span class=nf>generateEventID</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Type</span><span class=p>:</span><span class=w>      </span><span class=nx>eventType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Source</span><span class=p>:</span><span class=w>    </span><span class=nx>source</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Data</span><span class=p>:</span><span class=w>      </span><span class=nx>data</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Version</span><span class=p>:</span><span class=w>   </span><span class=s>&#34;1.0&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Timestamp</span><span class=p>:</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ToJSON converts the event to JSON for transmission</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>e</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=nf>ToJSON</span><span class=p>()</span><span class=w> </span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// FromJSON creates an event from JSON data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>FromJSON</span><span class=p>(</span><span class=nx>data</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Event</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=nx>Event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>generateEventID</span><span class=p>()</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Implementation would generate a unique ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Using UUID or similar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;evt_%d&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UnixNano</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Implement the event publisher:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/events/publisher.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/nats-io/nats.go&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Publisher</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=w> </span><span class=o>*</span><span class=nx>nats</span><span class=p>.</span><span class=nx>Conn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewPublisher</span><span class=p>(</span><span class=nx>natsURL</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Publisher</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>nats</span><span class=p>.</span><span class=nf>Connect</span><span class=p>(</span><span class=nx>natsURL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to connect to NATS: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Publisher</span><span class=p>{</span><span class=nx>conn</span><span class=p>:</span><span class=w> </span><span class=nx>conn</span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Publisher</span><span class=p>)</span><span class=w> </span><span class=nf>Publish</span><span class=p>(</span><span class=nx>subject</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>data</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nf>ToJSON</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to serialize event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to publish event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Published event %s to subject %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=nx>subject</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Publisher</span><span class=p>)</span><span class=w> </span><span class=nf>PublishSync</span><span class=p>(</span><span class=nx>subject</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Ensure message is delivered before returning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Flush</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>p</span><span class=w> </span><span class=o>*</span><span class=nx>Publisher</span><span class=p>)</span><span class=w> </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>p</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Create event consumers with different processing patterns:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/events/consumer.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;sync&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/nats-io/nats.go&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>EventHandler</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Consumer</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=w>         </span><span class=o>*</span><span class=nx>nats</span><span class=p>.</span><span class=nx>Conn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>handlers</span><span class=w>     </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>EventHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mu</span><span class=w>           </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>subscriptions</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>nats</span><span class=p>.</span><span class=nx>Subscription</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewConsumer</span><span class=p>(</span><span class=nx>natsURL</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Consumer</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>nats</span><span class=p>.</span><span class=nf>Connect</span><span class=p>(</span><span class=nx>natsURL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to connect to NATS: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Consumer</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>conn</span><span class=p>:</span><span class=w>     </span><span class=nx>conn</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>handlers</span><span class=p>:</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>EventHandler</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span><span class=w> </span><span class=nf>RegisterHandler</span><span class=p>(</span><span class=nx>eventType</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>handler</span><span class=w> </span><span class=nx>EventHandler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>eventType</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span><span class=w> </span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>subject</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sub</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Subscribe</span><span class=p>(</span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>handleMessage</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to subscribe to %s: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>subscriptions</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>subscriptions</span><span class=p>,</span><span class=w> </span><span class=nx>sub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Subscribed to subject: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>subject</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span><span class=w> </span><span class=nf>SubscribeQueue</span><span class=p>(</span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>queue</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sub</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>QueueSubscribe</span><span class=p>(</span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>queue</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>handleMessage</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to queue subscribe to %s: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>subscriptions</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>subscriptions</span><span class=p>,</span><span class=w> </span><span class=nx>sub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Queue subscribed to subject: %s, queue: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>subject</span><span class=p>,</span><span class=w> </span><span class=nx>queue</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span><span class=w> </span><span class=nf>handleMessage</span><span class=p>(</span><span class=nx>msg</span><span class=w> </span><span class=o>*</span><span class=nx>nats</span><span class=p>.</span><span class=nx>Msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>FromJSON</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to parse event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>handler</span><span class=p>,</span><span class=w> </span><span class=nx>exists</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>event</span><span class=p>.</span><span class=nx>Type</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>exists</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;No handler registered for event type: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>handler</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Handler failed for event %s: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// In production, you might want to implement retry logic or dead letter queues</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Consumer</span><span class=p>)</span><span class=w> </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>sub</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>subscriptions</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sub</span><span class=p>.</span><span class=nf>Unsubscribe</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=building-domain-services-with-event-publishing>Building Domain Services with Event Publishing</h2><p>Now let&rsquo;s implement domain services that publish events when important business operations occur:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/service.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;your-app/pkg/events&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Order</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>          </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerID</span><span class=w>  </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;customer_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Items</span><span class=w>       </span><span class=p>[]</span><span class=nx>Item</span><span class=w>    </span><span class=s>`json:&#34;items&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TotalAmount</span><span class=w> </span><span class=kt>float64</span><span class=w>   </span><span class=s>`json:&#34;total_amount&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Status</span><span class=w>      </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;status&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CreatedAt</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;created_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Item</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ProductID</span><span class=w> </span><span class=kt>string</span><span class=w>  </span><span class=s>`json:&#34;product_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Quantity</span><span class=w>  </span><span class=kt>int</span><span class=w>     </span><span class=s>`json:&#34;quantity&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Price</span><span class=w>     </span><span class=kt>float64</span><span class=w> </span><span class=s>`json:&#34;price&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Service</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>publisher</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nx>Publisher</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>repo</span><span class=w>      </span><span class=nx>Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewService</span><span class=p>(</span><span class=nx>publisher</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nx>Publisher</span><span class=p>,</span><span class=w> </span><span class=nx>repo</span><span class=w> </span><span class=nx>Repository</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Service</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>publisher</span><span class=p>:</span><span class=w> </span><span class=nx>publisher</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>repo</span><span class=p>:</span><span class=w>      </span><span class=nx>repo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=p>)</span><span class=w> </span><span class=nf>CreateOrder</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>customerID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>items</span><span class=w> </span><span class=p>[]</span><span class=nx>Item</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Order</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Calculate total amount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>totalAmount</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mf>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>items</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>totalAmount</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>item</span><span class=p>.</span><span class=nx>Price</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Quantity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>order</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Order</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>          </span><span class=nf>generateOrderID</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CustomerID</span><span class=p>:</span><span class=w>  </span><span class=nx>customerID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Items</span><span class=p>:</span><span class=w>       </span><span class=nx>items</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>TotalAmount</span><span class=p>:</span><span class=w> </span><span class=nx>totalAmount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Status</span><span class=p>:</span><span class=w>      </span><span class=s>&#34;pending&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CreatedAt</span><span class=p>:</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Save order to database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save order: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish order created event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nf>NewEvent</span><span class=p>(</span><span class=s>&#34;order.created&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;order-service&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;order_id&#34;</span><span class=p>:</span><span class=w>     </span><span class=nx>order</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;customer_id&#34;</span><span class=p>:</span><span class=w>  </span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;total_amount&#34;</span><span class=p>:</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;items&#34;</span><span class=p>:</span><span class=w>        </span><span class=nx>order</span><span class=p>.</span><span class=nx>Items</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;orders.events&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish order created event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Note: In production, you might want to use the outbox pattern</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// to ensure events are published reliably</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>order</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=p>)</span><span class=w> </span><span class=nf>UpdateOrderStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>,</span><span class=w> </span><span class=nx>status</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>order</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>GetByID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get order: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>previousStatus</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>Status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>order</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to update order: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish status change event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nf>NewEvent</span><span class=p>(</span><span class=s>&#34;order.status_changed&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;order-service&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;order_id&#34;</span><span class=p>:</span><span class=w>        </span><span class=nx>order</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;previous_status&#34;</span><span class=p>:</span><span class=w> </span><span class=nx>previousStatus</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;new_status&#34;</span><span class=p>:</span><span class=w>      </span><span class=nx>status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;updated_at&#34;</span><span class=p>:</span><span class=w>      </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>s</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;orders.events&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish order status changed event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>generateOrderID</span><span class=p>()</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;order_%d&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UnixNano</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Implement event handlers for different services:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/inventory/event_handler.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>inventory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;your-app/pkg/events&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>EventHandler</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>service</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewEventHandler</span><span class=p>(</span><span class=nx>service</span><span class=w> </span><span class=o>*</span><span class=nx>Service</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>EventHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>EventHandler</span><span class=p>{</span><span class=nx>service</span><span class=p>:</span><span class=w> </span><span class=nx>service</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>EventHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleOrderCreated</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>events</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>orderID</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;order_id&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid order_id in event data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>items</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=s>&#34;items&#34;</span><span class=p>].([]</span><span class=kd>interface</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid items in event data&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Processing inventory reservation for order: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Reserve inventory for each item</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>itemData</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>items</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>item</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>itemData</span><span class=p>.(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>continue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>productID</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>item</span><span class=p>[</span><span class=s>&#34;product_id&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>quantity</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>item</span><span class=p>[</span><span class=s>&#34;quantity&#34;</span><span class=p>].(</span><span class=kt>float64</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>service</span><span class=p>.</span><span class=nf>ReserveInventory</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>productID</span><span class=p>,</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>quantity</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to reserve inventory for product %s: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>productID</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Publish inventory reservation failed event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>failEvent</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nf>NewEvent</span><span class=p>(</span><span class=s>&#34;inventory.reservation_failed&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;inventory-service&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;order_id&#34;</span><span class=p>:</span><span class=w>   </span><span class=nx>orderID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;product_id&#34;</span><span class=p>:</span><span class=w> </span><span class=nx>productID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;quantity&#34;</span><span class=p>:</span><span class=w>   </span><span class=nx>quantity</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;reason&#34;</span><span class=p>:</span><span class=w>     </span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// This would typically use the same publisher instance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// h.publisher.Publish(&#34;inventory.events&#34;, failEvent)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish successful reservation event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>successEvent</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>events</span><span class=p>.</span><span class=nf>NewEvent</span><span class=p>(</span><span class=s>&#34;inventory.reserved&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;inventory-service&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;order_id&#34;</span><span class=p>:</span><span class=w> </span><span class=nx>orderID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;items&#34;</span><span class=p>:</span><span class=w>    </span><span class=nx>items</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// h.publisher.Publish(&#34;inventory.events&#34;, successEvent)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Successfully reserved inventory for order: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=implementing-event-sourcing-patterns>Implementing Event Sourcing Patterns</h2><p>Event sourcing takes event-driven architecture a step further by storing events as the primary source of truth. Instead of storing current state, you store the sequence of events that led to that state. This approach provides complete audit trails and enables powerful features like temporal queries and event replay.</p><p>Let&rsquo;s implement a basic event sourcing system:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/eventsourcing/event_store.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>eventsourcing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;database/sql&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;encoding/json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>StoredEvent</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>           </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>AggregateID</span><span class=w>  </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;aggregate_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>EventType</span><span class=w>    </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;event_type&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>EventData</span><span class=w>    </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;event_data&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Version</span><span class=w>      </span><span class=kt>int</span><span class=w>       </span><span class=s>`json:&#34;version&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CreatedAt</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;created_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>EventStore</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewEventStore</span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>EventStore</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>EventStore</span><span class=p>{</span><span class=nx>db</span><span class=p>:</span><span class=w> </span><span class=nx>db</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>es</span><span class=w> </span><span class=o>*</span><span class=nx>EventStore</span><span class=p>)</span><span class=w> </span><span class=nf>SaveEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=nx>expectedVersion</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventData</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to marshal event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventType</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getEventType</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>        INSERT INTO events (id, aggregate_id, event_type, event_data, version, created_at)
</span></span></span><span class=line><span class=cl><span class=s>        VALUES ($1, $2, $3, $4, $5, $6)
</span></span></span><span class=line><span class=cl><span class=s>    `</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventID</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>generateEventID</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>version</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>expectedVersion</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>es</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>ExecContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>eventID</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=p>,</span><span class=w> </span><span class=nx>eventType</span><span class=p>,</span><span class=w> </span><span class=nb>string</span><span class=p>(</span><span class=nx>eventData</span><span class=p>),</span><span class=w> </span><span class=nx>version</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>es</span><span class=w> </span><span class=o>*</span><span class=nx>EventStore</span><span class=p>)</span><span class=w> </span><span class=nf>GetEvents</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>fromVersion</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=nx>StoredEvent</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>        SELECT id, aggregate_id, event_type, event_data, version, created_at
</span></span></span><span class=line><span class=cl><span class=s>        FROM events
</span></span></span><span class=line><span class=cl><span class=s>        WHERE aggregate_id = $1 AND version &gt; $2
</span></span></span><span class=line><span class=cl><span class=s>        ORDER BY version ASC
</span></span></span><span class=line><span class=cl><span class=s>    `</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>es</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=p>,</span><span class=w> </span><span class=nx>fromVersion</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to query events: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>events</span><span class=w> </span><span class=p>[]</span><span class=nx>StoredEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=nx>StoredEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>AggregateID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>EventType</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>EventData</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>Version</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to scan event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>events</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>events</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>events</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>es</span><span class=w> </span><span class=o>*</span><span class=nx>EventStore</span><span class=p>)</span><span class=w> </span><span class=nf>GetAllEvents</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=nx>StoredEvent</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>es</span><span class=p>.</span><span class=nf>GetEvents</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>aggregateID</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>getEventType</span><span class=p>(</span><span class=nx>event</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Use reflection or type switches to determine event type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=nx>event</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;OrderCreated&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;OrderStatusChanged&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;Unknown&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Create domain events for event sourcing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/events.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>OrderID</span><span class=w>     </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;order_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerID</span><span class=w>  </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;customer_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Items</span><span class=w>       </span><span class=p>[]</span><span class=nx>Item</span><span class=w>    </span><span class=s>`json:&#34;items&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TotalAmount</span><span class=w> </span><span class=kt>float64</span><span class=w>   </span><span class=s>`json:&#34;total_amount&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CreatedAt</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;created_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>OrderID</span><span class=w>       </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;order_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>PreviousStatus</span><span class=w> </span><span class=kt>string</span><span class=w>   </span><span class=s>`json:&#34;previous_status&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>NewStatus</span><span class=w>     </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;new_status&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ChangedAt</span><span class=w>     </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;changed_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>OrderCancelledEvent</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>OrderID</span><span class=w>     </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;order_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Reason</span><span class=w>      </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;reason&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CancelledAt</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;cancelled_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Implement an aggregate root that uses event sourcing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/aggregate.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;your-app/pkg/eventsourcing&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>OrderAggregate</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>           </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerID</span><span class=w>   </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Items</span><span class=w>        </span><span class=p>[]</span><span class=nx>Item</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TotalAmount</span><span class=w>  </span><span class=kt>float64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Status</span><span class=w>       </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CreatedAt</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>version</span><span class=w>      </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewOrderAggregate</span><span class=p>(</span><span class=nx>customerID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>items</span><span class=w> </span><span class=p>[]</span><span class=nx>Item</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>orderID</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>generateOrderID</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>totalAmount</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>calculateTotal</span><span class=p>(</span><span class=nx>items</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>OrderAggregate</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>version</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Apply the order created event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>OrderID</span><span class=p>:</span><span class=w>     </span><span class=nx>orderID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CustomerID</span><span class=p>:</span><span class=w>  </span><span class=nx>customerID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Items</span><span class=p>:</span><span class=w>       </span><span class=nx>items</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>TotalAmount</span><span class=p>:</span><span class=w> </span><span class=nx>totalAmount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CreatedAt</span><span class=p>:</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>apply</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>recordEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>aggregate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>LoadOrderAggregate</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>eventStore</span><span class=w> </span><span class=o>*</span><span class=nx>eventsourcing</span><span class=p>.</span><span class=nx>EventStore</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>events</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>eventStore</span><span class=p>.</span><span class=nf>GetAllEvents</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to load events: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>events</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;order not found: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>orderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>OrderAggregate</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>storedEvent</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>events</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>deserializeEvent</span><span class=p>(</span><span class=nx>storedEvent</span><span class=p>.</span><span class=nx>EventType</span><span class=p>,</span><span class=w> </span><span class=nx>storedEvent</span><span class=p>.</span><span class=nx>EventData</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to deserialize event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>apply</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>aggregate</span><span class=p>.</span><span class=nx>version</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>storedEvent</span><span class=p>.</span><span class=nx>Version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>aggregate</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>oa</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>)</span><span class=w> </span><span class=nf>ChangeStatus</span><span class=p>(</span><span class=nx>newStatus</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>newStatus</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;order already has status: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>newStatus</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;cancelled&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;cannot change status of cancelled order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>OrderID</span><span class=p>:</span><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>PreviousStatus</span><span class=p>:</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>NewStatus</span><span class=p>:</span><span class=w>      </span><span class=nx>newStatus</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ChangedAt</span><span class=p>:</span><span class=w>      </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nf>apply</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nf>recordEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>oa</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>)</span><span class=w> </span><span class=nf>Cancel</span><span class=p>(</span><span class=nx>reason</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;cancelled&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;order already cancelled&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;completed&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;cannot cancel completed order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>OrderCancelledEvent</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>OrderID</span><span class=p>:</span><span class=w>     </span><span class=nx>oa</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Reason</span><span class=p>:</span><span class=w>      </span><span class=nx>reason</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CancelledAt</span><span class=p>:</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nf>apply</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nf>recordEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>oa</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>)</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=nx>event</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=nx>e</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>event</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>ID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>OrderID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>CustomerID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>CustomerID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Items</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>Items</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;pending&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>e</span><span class=p>.</span><span class=nx>NewStatus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>OrderCancelledEvent</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;cancelled&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>oa</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>)</span><span class=w> </span><span class=nf>recordEvent</span><span class=p>(</span><span class=nx>event</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>oa</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>oa</span><span class=w> </span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>)</span><span class=w> </span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>eventStore</span><span class=w> </span><span class=o>*</span><span class=nx>eventsourcing</span><span class=p>.</span><span class=nx>EventStore</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>eventStore</span><span class=p>.</span><span class=nf>SaveEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>oa</span><span class=p>.</span><span class=nx>version</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>oa</span><span class=p>.</span><span class=nx>version</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>oa</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>calculateTotal</span><span class=p>(</span><span class=nx>items</span><span class=w> </span><span class=p>[]</span><span class=nx>Item</span><span class=p>)</span><span class=w> </span><span class=kt>float64</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>total</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mf>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>item</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>items</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>total</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>item</span><span class=p>.</span><span class=nx>Price</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>Quantity</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>total</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>deserializeEvent</span><span class=p>(</span><span class=nx>eventType</span><span class=p>,</span><span class=w> </span><span class=nx>eventData</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kd>interface</span><span class=p>{},</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=nx>eventType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=s>&#34;OrderCreated&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>eventData</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=s>&#34;OrderStatusChanged&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>eventData</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=s>&#34;OrderCancelled&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=nx>OrderCancelledEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>eventData</span><span class=p>),</span><span class=w> </span><span class=o>&amp;</span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unknown event type: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>eventType</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=implementing-cqrs-with-event-driven-architecture>Implementing CQRS with Event-Driven Architecture</h2><p>Command Query Responsibility Segregation (CQRS) pairs naturally with event-driven architecture. CQRS separates read and write operations, allowing you to optimize each side independently. Events serve as the bridge between the command side (writes) and query side (reads).</p><p>Let&rsquo;s implement a CQRS system with event-driven updates:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/commands.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;your-app/pkg/eventsourcing&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>CommandHandler</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventStore</span><span class=w> </span><span class=o>*</span><span class=nx>eventsourcing</span><span class=p>.</span><span class=nx>EventStore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>publisher</span><span class=w>  </span><span class=nx>EventPublisher</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewCommandHandler</span><span class=p>(</span><span class=nx>eventStore</span><span class=w> </span><span class=o>*</span><span class=nx>eventsourcing</span><span class=p>.</span><span class=nx>EventStore</span><span class=p>,</span><span class=w> </span><span class=nx>publisher</span><span class=w> </span><span class=nx>EventPublisher</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>CommandHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>CommandHandler</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>eventStore</span><span class=p>:</span><span class=w> </span><span class=nx>eventStore</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>publisher</span><span class=p>:</span><span class=w>  </span><span class=nx>publisher</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>CreateOrderCommand</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerID</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;customer_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Items</span><span class=w>      </span><span class=p>[]</span><span class=nx>Item</span><span class=w> </span><span class=s>`json:&#34;items&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>ChangeOrderStatusCommand</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>OrderID</span><span class=w>   </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;order_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>NewStatus</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`json:&#34;new_status&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>ch</span><span class=w> </span><span class=o>*</span><span class=nx>CommandHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleCreateOrder</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>cmd</span><span class=w> </span><span class=nx>CreateOrderCommand</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>OrderAggregate</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create new aggregate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>NewOrderAggregate</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w> </span><span class=nx>cmd</span><span class=p>.</span><span class=nx>Items</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Save events to event store</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nx>eventStore</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save order aggregate: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish events to message queue for read model updates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>aggregate</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>PublishDomainEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// In production, you might want to implement compensation logic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>aggregate</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>ch</span><span class=w> </span><span class=o>*</span><span class=nx>CommandHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleChangeOrderStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>cmd</span><span class=w> </span><span class=nx>ChangeOrderStatusCommand</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Load aggregate from event store</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>aggregate</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>LoadOrderAggregate</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cmd</span><span class=p>.</span><span class=nx>OrderID</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nx>eventStore</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to load order aggregate: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Execute business logic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>ChangeStatus</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nx>NewStatus</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to change order status: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Save new events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>aggregate</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nx>eventStore</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save order aggregate: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish events for read model updates</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>aggregate</span><span class=p>.</span><span class=nx>uncommittedEvents</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>PublishDomainEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Implement read models that are updated via events:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/read_model.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;database/sql&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;encoding/json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>OrderReadModel</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ID</span><span class=w>           </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;id&#34; db:&#34;id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerID</span><span class=w>   </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;customer_id&#34; db:&#34;customer_id&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CustomerName</span><span class=w> </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;customer_name&#34; db:&#34;customer_name&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ItemCount</span><span class=w>    </span><span class=kt>int</span><span class=w>       </span><span class=s>`json:&#34;item_count&#34; db:&#34;item_count&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>TotalAmount</span><span class=w>  </span><span class=kt>float64</span><span class=w>   </span><span class=s>`json:&#34;total_amount&#34; db:&#34;total_amount&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Status</span><span class=w>       </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;status&#34; db:&#34;status&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>CreatedAt</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;created_at&#34; db:&#34;created_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>UpdatedAt</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;updated_at&#34; db:&#34;updated_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>ReadModelRepository</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewReadModelRepository</span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ReadModelRepository</span><span class=p>{</span><span class=nx>db</span><span class=p>:</span><span class=w> </span><span class=nx>db</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=p>)</span><span class=w> </span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=w> </span><span class=o>*</span><span class=nx>OrderReadModel</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>        INSERT INTO order_read_models (id, customer_id, customer_name, item_count, total_amount, status, created_at, updated_at)
</span></span></span><span class=line><span class=cl><span class=s>        VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
</span></span></span><span class=line><span class=cl><span class=s>        ON CONFLICT (id)
</span></span></span><span class=line><span class=cl><span class=s>        DO UPDATE SET
</span></span></span><span class=line><span class=cl><span class=s>            customer_name = EXCLUDED.customer_name,
</span></span></span><span class=line><span class=cl><span class=s>            item_count = EXCLUDED.item_count,
</span></span></span><span class=line><span class=cl><span class=s>            total_amount = EXCLUDED.total_amount,
</span></span></span><span class=line><span class=cl><span class=s>            status = EXCLUDED.status,
</span></span></span><span class=line><span class=cl><span class=s>            updated_at = EXCLUDED.updated_at
</span></span></span><span class=line><span class=cl><span class=s>    `</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>ExecContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>order</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerName</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>ItemCount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>order</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>,</span><span class=w> </span><span class=nx>order</span><span class=p>.</span><span class=nx>UpdatedAt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=p>)</span><span class=w> </span><span class=nf>GetByID</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>id</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>OrderReadModel</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>        SELECT id, customer_id, customer_name, item_count, total_amount, status, created_at, updated_at
</span></span></span><span class=line><span class=cl><span class=s>        FROM order_read_models WHERE id = $1
</span></span></span><span class=line><span class=cl><span class=s>    `</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>order</span><span class=w> </span><span class=nx>OrderReadModel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryRowContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>id</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerName</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>ItemCount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>UpdatedAt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=p>)</span><span class=w> </span><span class=nf>GetByCustomerID</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>customerID</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=o>*</span><span class=nx>OrderReadModel</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>        SELECT id, customer_id, customer_name, item_count, total_amount, status, created_at, updated_at
</span></span></span><span class=line><span class=cl><span class=s>        FROM order_read_models
</span></span></span><span class=line><span class=cl><span class=s>        WHERE customer_id = $1
</span></span></span><span class=line><span class=cl><span class=s>        ORDER BY created_at DESC
</span></span></span><span class=line><span class=cl><span class=s>    `</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>customerID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>orders</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>OrderReadModel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>order</span><span class=w> </span><span class=nx>OrderReadModel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CustomerName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>ItemCount</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>.</span><span class=nx>UpdatedAt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>orders</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>orders</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>order</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>orders</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Create event handlers for read model updates:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// internal/order/read_model_handler.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>order</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;your-app/pkg/events&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>ReadModelHandler</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>repo</span><span class=w>         </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>customerRepo</span><span class=w> </span><span class=nx>CustomerRepository</span><span class=w> </span><span class=c1>// For enriching read models</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewReadModelHandler</span><span class=p>(</span><span class=nx>repo</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelRepository</span><span class=p>,</span><span class=w> </span><span class=nx>customerRepo</span><span class=w> </span><span class=nx>CustomerRepository</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ReadModelHandler</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>repo</span><span class=p>:</span><span class=w>         </span><span class=nx>repo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>customerRepo</span><span class=p>:</span><span class=w> </span><span class=nx>customerRepo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleOrderCreated</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>events</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>orderEvent</span><span class=w> </span><span class=nx>OrderCreatedEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventData</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>eventData</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>orderEvent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to unmarshal order created event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Enrich with customer data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>customer</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>customerRepo</span><span class=p>.</span><span class=nf>GetByID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to get customer data: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Continue with empty customer name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>customerName</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>customer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>customerName</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>customer</span><span class=p>.</span><span class=nx>Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>readModel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>OrderReadModel</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>           </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>OrderID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CustomerID</span><span class=p>:</span><span class=w>   </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>CustomerID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CustomerName</span><span class=p>:</span><span class=w> </span><span class=nx>customerName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ItemCount</span><span class=p>:</span><span class=w>    </span><span class=nb>len</span><span class=p>(</span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>Items</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>TotalAmount</span><span class=p>:</span><span class=w>  </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>TotalAmount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Status</span><span class=p>:</span><span class=w>       </span><span class=s>&#34;pending&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>CreatedAt</span><span class=p>:</span><span class=w>    </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>UpdatedAt</span><span class=p>:</span><span class=w>    </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>CreatedAt</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>readModel</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to save order read model: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Updated read model for order: %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>orderEvent</span><span class=p>.</span><span class=nx>OrderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>ReadModelHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleOrderStatusChanged</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>events</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>statusEvent</span><span class=w> </span><span class=nx>OrderStatusChangedEvent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventData</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>Data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>eventData</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>statusEvent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to unmarshal order status changed event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Load existing read model</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>readModel</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>GetByID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>statusEvent</span><span class=p>.</span><span class=nx>OrderID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get existing read model: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Update status and timestamp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>readModel</span><span class=p>.</span><span class=nx>Status</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>statusEvent</span><span class=p>.</span><span class=nx>NewStatus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>readModel</span><span class=p>.</span><span class=nx>UpdatedAt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>statusEvent</span><span class=p>.</span><span class=nx>ChangedAt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>repo</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>readModel</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to update order read model: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Updated read model status for order: %s to %s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>statusEvent</span><span class=p>.</span><span class=nx>OrderID</span><span class=p>,</span><span class=w> </span><span class=nx>statusEvent</span><span class=p>.</span><span class=nx>NewStatus</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=error-handling-and-resilience-patterns>Error Handling and Resilience Patterns</h2><p>Event-driven systems require robust error handling and resilience patterns. Network failures, service outages, and processing errors are inevitable in distributed systems.</p><p>Implement retry mechanisms with exponential backoff:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/resilience/retry.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>resilience</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;math&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>RetryConfig</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>MaxAttempts</span><span class=w> </span><span class=kt>int</span><span class=w>           </span><span class=s>`json:&#34;max_attempts&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>BaseDelay</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=s>`json:&#34;base_delay&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>MaxDelay</span><span class=w>    </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=s>`json:&#34;max_delay&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Multiplier</span><span class=w>  </span><span class=kt>float64</span><span class=w>       </span><span class=s>`json:&#34;multiplier&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>DefaultRetryConfig</span><span class=p>()</span><span class=w> </span><span class=nx>RetryConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>RetryConfig</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>MaxAttempts</span><span class=p>:</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>BaseDelay</span><span class=p>:</span><span class=w>   </span><span class=mi>100</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>MaxDelay</span><span class=p>:</span><span class=w>    </span><span class=mi>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>Multiplier</span><span class=p>:</span><span class=w>  </span><span class=mf>2.0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>RetryWithBackoff</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=w> </span><span class=nx>RetryConfig</span><span class=p>,</span><span class=w> </span><span class=nx>operation</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>lastErr</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>attempt</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>attempt</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxAttempts</span><span class=p>;</span><span class=w> </span><span class=nx>attempt</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>lastErr</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>operation</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>lastErr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>attempt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxAttempts</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Calculate delay with exponential backoff</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>delay</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>BaseDelay</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>math</span><span class=p>.</span><span class=nf>Pow</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>Multiplier</span><span class=p>,</span><span class=w> </span><span class=nb>float64</span><span class=p>(</span><span class=nx>attempt</span><span class=o>-</span><span class=mi>1</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>delay</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxDelay</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>delay</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxDelay</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Operation failed (attempt %d/%d): %v. Retrying in %v&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=nx>attempt</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxAttempts</span><span class=p>,</span><span class=w> </span><span class=nx>lastErr</span><span class=p>,</span><span class=w> </span><span class=nx>delay</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>delay</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Continue to next attempt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;operation failed after %d attempts: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>config</span><span class=p>.</span><span class=nx>MaxAttempts</span><span class=p>,</span><span class=w> </span><span class=nx>lastErr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Implement dead letter queue handling:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/events/dead_letter.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;encoding/json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>DeadLetter</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>OriginalEvent</span><span class=w>  </span><span class=o>*</span><span class=nx>Event</span><span class=w>    </span><span class=s>`json:&#34;original_event&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>FailureReason</span><span class=w>  </span><span class=kt>string</span><span class=w>    </span><span class=s>`json:&#34;failure_reason&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>FailureCount</span><span class=w>   </span><span class=kt>int</span><span class=w>       </span><span class=s>`json:&#34;failure_count&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>FirstFailedAt</span><span class=w>  </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;first_failed_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>LastFailedAt</span><span class=w>   </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=s>`json:&#34;last_failed_at&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>DeadLetterHandler</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>publisher</span><span class=w> </span><span class=o>*</span><span class=nx>Publisher</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>storage</span><span class=w>   </span><span class=nx>DeadLetterStorage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewDeadLetterHandler</span><span class=p>(</span><span class=nx>publisher</span><span class=w> </span><span class=o>*</span><span class=nx>Publisher</span><span class=p>,</span><span class=w> </span><span class=nx>storage</span><span class=w> </span><span class=nx>DeadLetterStorage</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>DeadLetterHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>DeadLetterHandler</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>publisher</span><span class=p>:</span><span class=w> </span><span class=nx>publisher</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>storage</span><span class=p>:</span><span class=w>   </span><span class=nx>storage</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>dlh</span><span class=w> </span><span class=o>*</span><span class=nx>DeadLetterHandler</span><span class=p>)</span><span class=w> </span><span class=nf>HandleFailedEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=o>*</span><span class=nx>Event</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>deadLetter</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>DeadLetter</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>OriginalEvent</span><span class=p>:</span><span class=w> </span><span class=nx>event</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>FailureReason</span><span class=p>:</span><span class=w> </span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>FailureCount</span><span class=p>:</span><span class=w>  </span><span class=mi>1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>FirstFailedAt</span><span class=p>:</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>LastFailedAt</span><span class=p>:</span><span class=w>  </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Check if this event has failed before</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>existing</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>GetByEventID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>existing</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>FailureCount</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>FailureCount</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>FirstFailedAt</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>existing</span><span class=p>.</span><span class=nx>FirstFailedAt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Store in dead letter storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>deadLetter</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to save dead letter: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Publish to dead letter queue for manual processing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>dlEvent</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>NewEvent</span><span class=p>(</span><span class=s>&#34;dead_letter.created&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;dead-letter-handler&#34;</span><span class=p>,</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;event_id&#34;</span><span class=p>:</span><span class=w>       </span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;failure_reason&#34;</span><span class=p>:</span><span class=w> </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>FailureReason</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;failure_count&#34;</span><span class=p>:</span><span class=w>  </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>FailureCount</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;dead_letters&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>dlEvent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to publish dead letter event: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Event %s moved to dead letter queue after %d failures&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span><span class=w> </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>FailureCount</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>dlh</span><span class=w> </span><span class=o>*</span><span class=nx>DeadLetterHandler</span><span class=p>)</span><span class=w> </span><span class=nf>ReprocessDeadLetter</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>eventID</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>deadLetter</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>GetByEventID</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>eventID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get dead letter: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Republish the original event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>publisher</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;retry_queue&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>deadLetter</span><span class=p>.</span><span class=nx>OriginalEvent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to republish event: %w&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Remove from dead letter storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>dlh</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>eventID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Failed to delete dead letter: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=performance-optimization-and-monitoring>Performance Optimization and Monitoring</h2><p>Event-driven systems require careful monitoring to ensure healthy operation. Implement comprehensive metrics and observability:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// pkg/monitoring/metrics.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nx>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/prometheus/client_golang/prometheus&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;github.com/prometheus/client_golang/prometheus/promauto&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>EventMetrics</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventsPublished</span><span class=w>   </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Counter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventsConsumed</span><span class=w>    </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Counter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>eventsFailed</span><span class=w>      </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Counter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>processingTime</span><span class=w>    </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Histogram</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>queueDepth</span><span class=w>        </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Gauge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>NewEventMetrics</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=nx>EventMetrics</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>EventMetrics</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>eventsPublished</span><span class=p>:</span><span class=w> </span><span class=nx>promauto</span><span class=p>.</span><span class=nf>NewCounter</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>CounterOpts</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&#34;events_published_total&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Help</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Total number of events published&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>eventsConsumed</span><span class=p>:</span><span class=w> </span><span class=nx>promauto</span><span class=p>.</span><span class=nf>NewCounter</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>CounterOpts</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&#34;events_consumed_total&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Help</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Total number of events consumed&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>eventsFailed</span><span class=p>:</span><span class=w> </span><span class=nx>promauto</span><span class=p>.</span><span class=nf>NewCounter</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>CounterOpts</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&#34;events_failed_total&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Help</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Total number of failed event processing attempts&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>processingTime</span><span class=p>:</span><span class=w> </span><span class=nx>promauto</span><span class=p>.</span><span class=nf>NewHistogram</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>HistogramOpts</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&#34;event_processing_duration_seconds&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Help</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Time taken to process events&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Buckets</span><span class=p>:</span><span class=w> </span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>DefBuckets</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>queueDepth</span><span class=p>:</span><span class=w> </span><span class=nx>promauto</span><span class=p>.</span><span class=nf>NewGauge</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>GaugeOpts</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Name</span><span class=p>:</span><span class=w> </span><span class=s>&#34;event_queue_depth&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Help</span><span class=p>:</span><span class=w> </span><span class=s>&#34;Current depth of event queue&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>em</span><span class=w> </span><span class=o>*</span><span class=nx>EventMetrics</span><span class=p>)</span><span class=w> </span><span class=nf>RecordEventPublished</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>em</span><span class=p>.</span><span class=nx>eventsPublished</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>em</span><span class=w> </span><span class=o>*</span><span class=nx>EventMetrics</span><span class=p>)</span><span class=w> </span><span class=nf>RecordEventConsumed</span><span class=p>(</span><span class=nx>duration</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>em</span><span class=p>.</span><span class=nx>eventsConsumed</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>em</span><span class=p>.</span><span class=nx>processingTime</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nx>duration</span><span class=p>.</span><span class=nf>Seconds</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>em</span><span class=w> </span><span class=o>*</span><span class=nx>EventMetrics</span><span class=p>)</span><span class=w> </span><span class=nf>RecordEventFailed</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>em</span><span class=p>.</span><span class=nx>eventsFailed</span><span class=p>.</span><span class=nf>Inc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>em</span><span class=w> </span><span class=o>*</span><span class=nx>EventMetrics</span><span class=p>)</span><span class=w> </span><span class=nf>UpdateQueueDepth</span><span class=p>(</span><span class=nx>depth</span><span class=w> </span><span class=kt>float64</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>em</span><span class=p>.</span><span class=nx>queueDepth</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>depth</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=production-deployment-and-best-practices>Production Deployment and Best Practices</h2><p>When deploying event-driven systems to production, several key considerations ensure reliability and performance:</p><p><strong>Message Ordering</strong>: For scenarios requiring strict ordering, use partitioned topics or single-threaded consumers. However, consider whether eventual consistency might be acceptable to achieve better performance.</p><p><strong>Idempotency</strong>: Design event handlers to be idempotent since message delivery guarantees might result in duplicate processing. Use event IDs or business keys to detect and handle duplicates.</p><p><strong>Event Schema Evolution</strong>: Plan for event schema changes by using versioned events and maintaining backward compatibility. Consider using tools like Protocol Buffers or Avro for schema evolution support.</p><p><strong>Monitoring and Alerting</strong>: Implement comprehensive monitoring for queue depths, processing latencies, error rates, and dead letter queues. Set up alerts for unusual patterns that might indicate system issues.</p><p><strong>Capacity Planning</strong>: Monitor resource usage patterns and plan for scaling both message brokers and consumers based on traffic patterns and growth projections.</p><h2 id=conclusion>Conclusion</h2><p>Event-driven architecture with Go provides a powerful foundation for building scalable, resilient distributed systems. The patterns and implementations covered in this guide demonstrate how to leverage Go&rsquo;s strengths while addressing the unique challenges of asynchronous, event-based communication.</p><p>Key takeaways include the importance of choosing the right message queue technology for your needs, implementing proper error handling and resilience patterns, and maintaining comprehensive monitoring and observability. Whether you&rsquo;re building <a href=/2025/09/microservices-golang-architecture-implementation-guide.html>microservices systems
</a>or modernizing existing applications, event-driven patterns can significantly improve scalability and maintainability.</p><p>The investment in understanding event-driven architecture patterns pays dividends in building applications that can handle high throughput, provide better user experiences through asynchronous processing, and maintain system reliability even when individual components experience failures. As your systems grow in complexity, these patterns become essential tools for managing distributed system challenges while maintaining development velocity and operational stability.</p></p><div class="bg-gray-100 dark:bg-gray-800 p-4 my-8 rounded"><h2 class="text-lg font-semibold mb-2">ðŸ“Œ Read Also</h2><ul class="list-disc list-outside ml-5"><li><a href=/2025/09/microservices-golang-architecture-implementation-guide.html class="text-gray-900 dark:text-white hover:text-[#0f7ea9] no-underline">Microservices with Golang - Architecture and Implementation Guide</a></li><li><a href=/2025/09/building-graphql-server-gqlgen-golang.html class="text-gray-900 dark:text-white hover:text-[#0f7ea9] no-underline">Building GraphQL Server with gqlgen in Golang</a></li><li><a href=/2025/09/graphql-golang-modern-alternative-rest-api.html class="text-gray-900 dark:text-white hover:text-[#0f7ea9] no-underline">GraphQL with Golang - A Modern Alternative to REST API</a></li></ul></div><div class="hidden lg:block"><div class="my-8 py-6 border-t border-b border-gray-200 dark:border-gray-700"><div class="max-w-4xl mx-auto"><div class="text-center mb-3"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><div class="flex justify-center"><ins class=adsbygoogle style=display:block;min-height:90px;max-width:100% data-ad-client=ca-pub-3149036684216973 data-ad-slot=3879195288 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div><div class="block lg:hidden my-8 px-2 mb-10"><div class="text-center mb-2"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><div class="flex justify-center"><ins class=adsbygoogle style=display:block;min-height:50px;max-width:100% data-ad-client=ca-pub-3149036684216973 data-ad-slot=3879195288 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="lg:hidden mt-8 pt-8 border-t border-gray-200 dark:border-gray-700"><h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Popular Posts</h3><div class="grid gap-3"><a href=/2025/09/event-driven-architecture-golang-message-queues.html class="block py-2 hover:text-[#0f7ea9] transition no-underline"><h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">Event-Driven Architecture with Golang and Message Queues</h4><p class="text-xs text-gray-500 dark:text-gray-400">27 Sep 2025</p></a><a href=/2025/09/microservices-golang-architecture-implementation-guide.html class="block py-2 hover:text-[#0f7ea9] transition no-underline"><h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">Microservices with Golang - Architecture and Implementation Guide</h4><p class="text-xs text-gray-500 dark:text-gray-400">27 Sep 2025</p></a><a href=/2025/09/building-graphql-server-gqlgen-golang.html class="block py-2 hover:text-[#0f7ea9] transition no-underline"><h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">Building GraphQL Server with gqlgen in Golang</h4><p class="text-xs text-gray-500 dark:text-gray-400">26 Sep 2025</p></a><a href=/2025/09/graphql-golang-modern-alternative-rest-api.html class="block py-2 hover:text-[#0f7ea9] transition no-underline"><h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">GraphQL with Golang - A Modern Alternative to REST API</h4><p class="text-xs text-gray-500 dark:text-gray-400">26 Sep 2025</p></a><a href=/2025/09/fiber-vs-gin-vs-echo-golang-framework-comparison-2025.html class="block py-2 hover:text-[#0f7ea9] transition no-underline"><h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">Fiber vs Gin vs Echo - Go Framework Comparison 2025</h4><p class="text-xs text-gray-500 dark:text-gray-400">25 Sep 2025</p></a></div></div><div class="my-8 py-6"><div class="max-w-4xl mx-auto"><div class="text-center mb-3"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><div class="flex justify-center"><ins class=adsbygoogle style=display:block data-ad-format=autorelaxed data-ad-client=ca-pub-3149036684216973 data-ad-slot=7106179106></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></article><aside class="space-y-10 hidden lg:block"><div><h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Popular Posts</h3><ul class="space-y-3 list-disc list-outside pl-5 text-sm text-gray-800 dark:text-gray-200"><li><a href=/2025/09/event-driven-architecture-golang-message-queues.html class="hover:text-[#0f7ea9] transition">Event-Driven Architecture with Golang and Message Queues</a></li><li><a href=/2025/09/microservices-golang-architecture-implementation-guide.html class="hover:text-[#0f7ea9] transition">Microservices with Golang - Architecture and Implementation Guide</a></li><li><a href=/2025/09/building-graphql-server-gqlgen-golang.html class="hover:text-[#0f7ea9] transition">Building GraphQL Server with gqlgen in Golang</a></li><li><a href=/2025/09/graphql-golang-modern-alternative-rest-api.html class="hover:text-[#0f7ea9] transition">GraphQL with Golang - A Modern Alternative to REST API</a></li><li><a href=/2025/09/fiber-vs-gin-vs-echo-golang-framework-comparison-2025.html class="hover:text-[#0f7ea9] transition">Fiber vs Gin vs Echo - Go Framework Comparison 2025</a></li></ul></div></aside></div><section id=comments class=mt-12><script src=https://giscus.app/client.js data-repo=wikukarno/buanacoding data-repo-id=R_kgD0Oj4jAw data-category=General data-category-id=DIC_kwD0Oj4jA84Cr_fx data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></section></div></main><div class=py-6><div class="max-w-7xl mx-auto px-4"><div class="text-center mb-3"><span class="text-xs text-gray-400 dark:text-gray-500 uppercase tracking-wide font-medium">Advertisement</span></div><div class="flex justify-center"><ins class=adsbygoogle style=display:block;min-height:90px;max-width:100% data-ad-client=ca-pub-3149036684216973 data-ad-slot=3879195288 data-ad-format=auto data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div><div class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white py-4 transition-colors duration-300"><div class="text-center space-x-4 text-sm font-medium"><a href=/about class="hover:text-cyan-500 dark:hover:text-cyan-400">About</a>
<span>-</span>
<a href=/contact class="hover:text-cyan-500 dark:hover:text-cyan-400">Contact</a>
<span>-</span>
<a href=/privacy-policy class="hover:text-cyan-500 dark:hover:text-cyan-400">Privacy Policy</a>
<span>-</span>
<a href=/disclaimer class="hover:text-cyan-500 dark:hover:text-cyan-400">Disclaimer</a></div></div><footer class="text-center text-sm text-gray-500 dark:text-gray-400 py-4 border-t border-gray-200 dark:border-gray-700">&copy; 2025 buanacoding.com</footer><button id=scrollToTop class="fixed bottom-6 right-6 lg:bottom-6 lg:right-6 bg-[#0f7ea9] hover:bg-cyan-600 text-white p-3 rounded-full shadow transition duration-300 z-50" aria-label="Scroll to top">
<svg fill="none" class="w-4 h-4" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg></button><style>body.floating-ad-active #scrollToTop{bottom:100px!important}@media(min-width:1024px){body.floating-ad-active #scrollToTop{bottom:1.5rem!important}}</style><div id=google_translate_element style=display:none></div><script src=https://unpkg.com/feather-icons></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.4.6></script><script>feather.replace();const btn=document.getElementById("scrollToTop"),html=document.documentElement,toggleBtn=document.getElementById("theme-toggle"),toggleBtnMobile=document.getElementById("theme-toggle-mobile"),iconSun=document.getElementById("icon-sun"),iconMoon=document.getElementById("icon-moon"),iconSunMobile=document.getElementById("icon-sun-mobile"),iconMoonMobile=document.getElementById("icon-moon-mobile");document.getElementById("menu-toggle")?.addEventListener("click",()=>{document.getElementById("mobile-menu")?.classList.toggle("hidden")}),btn.style.display="none",window.addEventListener("scroll",()=>{window.scrollY>300?btn.style.display="flex":btn.style.display="none"}),btn.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})});function updateIcons(e){iconSun.classList.toggle("hidden",!e),iconMoon.classList.toggle("hidden",e),iconSunMobile.classList.toggle("hidden",!e),iconMoonMobile.classList.toggle("hidden",e)}function setDarkMode(e){html.setAttribute("data-theme",e?"dark":"light"),localStorage.setItem("theme",e?"dark":"light"),updateIcons(e)}const userPref=localStorage.getItem("theme"),systemPref=window.matchMedia("(prefers-color-scheme: dark)").matches,isDark=userPref==="dark"||!userPref&&systemPref;setDarkMode(isDark),toggleBtn?.addEventListener("click",()=>{const e=html.getAttribute("data-theme")==="dark";setDarkMode(!e)}),toggleBtnMobile?.addEventListener("click",()=>{const e=html.getAttribute("data-theme")==="dark";setDarkMode(!e)}),document.querySelectorAll("pre").forEach(e=>{const t=document.createElement("button");t.innerHTML=`
      <span>Copy</span>
    `,t.className=`
    copy-btn absolute top-2 right-2
    text-xs px-2 py-1 rounded flex items-center gap-1
    transition-colors duration-200
    bg-gray-200 text-gray-800 hover:bg-gray-300
    dark:bg-white/10 dark:text-white dark:hover:bg-white/20
  `.trim();const n=document.createElement("div");n.className="relative",e.parentNode.insertBefore(n,e),n.appendChild(e),n.appendChild(t),t.addEventListener("click",()=>{const n=e.innerText;navigator.clipboard.writeText(n).then(()=>{t.querySelector("span").innerText="Copied!",setTimeout(()=>{t.querySelector("span").innerText="Copy"},2e3)})})});const openBtn=document.getElementById("openSearchModal"),closeBtn=document.getElementById("closeSearchModal"),modal=document.getElementById("searchModal");openBtn.addEventListener("click",()=>{console.log("Search modal opened"),modal.classList.remove("hidden"),document.getElementById("searchBox").focus()}),closeBtn.addEventListener("click",()=>{modal.classList.add("hidden")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&modal.classList.add("hidden")}),fetch("/index.json").then(e=>e.json()).then(e=>{const n=new Fuse(e,{keys:["title","content"],threshold:.3}),s=document.getElementById("searchBox"),t=document.getElementById("results");s.addEventListener("input",function(e){const o=e.target.value.trim(),s=document.getElementById("searchAdBanner");if(o.length<2){t.innerHTML="",s&&(s.classList.remove("show"),s.classList.add("hide"),setTimeout(()=>s.style.display="none",300));return}s&&(s.style.display="block",s.classList.remove("hide"),s.classList.add("show"));const i=n.search(o);if(i.length===0)t.innerHTML=`
            <li class='px-4 py-3 text-center text-gray-500 dark:text-gray-400'>
              <div class="mb-2">ðŸ“„ No results found for "${o}"</div>
              <div class="text-xs">Try different keywords or browse categories below</div>
            </li>
          `;else{let e="";i.forEach((t,n)=>{e+=`
              <li class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <a href="${t.item.href}" class="block font-semibold text-gray-900 dark:text-white no-underline">${t.item.title}</a>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${t.item.content.substring(0,100)}...</p>
              </li>
            `,(n+1)%3===0&&n<i.length-1&&(e+=`
                <li class="px-4 py-2 bg-blue-50 dark:bg-gray-800 border-l-4 border-blue-400">
                  <div class="text-xs text-blue-600 dark:text-blue-400 font-medium">ðŸ“š More related articles</div>
                </li>
              `)}),t.innerHTML=e}})});const openBtnMobile=document.getElementById("openSearchModalMobile"),closeBtnMobile=document.getElementById("closeSearchModal"),modalMobile=document.getElementById("searchModal");openBtnMobile.addEventListener("click",()=>{console.log("Search modal opened (mobile)"),modalMobile.classList.remove("hidden"),document.getElementById("searchBox").focus()}),closeBtnMobile.addEventListener("click",()=>{modalMobile.classList.add("hidden")}),document.addEventListener("keydown",e=>{e.key==="Escape"&&modalMobile.classList.add("hidden")}),function(){function t(e,t){if(window.google&&window.google.translate&&window.google.translate.TranslateElement){e&&e();return}if(window.__gtReadyCallbacks=window.__gtReadyCallbacks||[],e&&window.__gtReadyCallbacks.push(e),window.__gtLoading)return;window.__gtLoading=!0,window.initGoogleTranslate=function(){try{new window.google.translate.TranslateElement({pageLanguage:"en",includedLanguages:"id",autoDisplay:!1},"google_translate_element")}catch{}(window.__gtReadyCallbacks||[]).forEach(function(e){try{e()}catch{}}),window.__gtReadyCallbacks=[]};var s,n=document.createElement("script");n.src="https://translate.google.com/translate_a/element.js?cb=initGoogleTranslate",n.defer=!0,s=!1,n.onerror=function(){s=!0,t&&t()},setTimeout(function(){(!window.google||!window.google.translate)&&(s=!0,t&&t())},4e3),document.head.appendChild(n)}function n(e,t){document.cookie=e+"="+t+"; path=/; expires="+new Date(Date.now()+365*24*3600*1e3).toUTCString()}function e(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"}function s(){if(document.getElementById("translate-fallback"))return;var e=document.createElement("div");e.id="translate-fallback",e.style.cssText="position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:9999;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.25);display:flex;gap:10px;align-items:center;",e.innerHTML='<span style="font-size:13px">Auto-translate tidak tersedia di perangkat ini.</span><button id="btnTryId" style="background:#0ea5e9;color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:12px">Coba versi Indonesia</button><button id="btnCloseTf" style="background:transparent;color:#fff;border:1px solid #fff3;padding:6px 10px;border-radius:8px;font-size:12px">Tutup</button>',document.body.appendChild(e),document.getElementById("btnCloseTf").onclick=function(){e.remove()},document.getElementById("btnTryId").onclick=function(){var t=new URL(location.href),e=location.pathname;e.startsWith("/id/")||(t.pathname="/id"+(e.startsWith("/")?e:"/"+e)),fetch(t,{method:"HEAD"}).then(function(e){e.ok?location.href=t:location.href="/id/"}).catch(function(){location.href="/id/"})}}function o(e){t(function(){var t=document.querySelector(".goog-te-combo");t?(t.value=e,t.dispatchEvent(new Event("change"))):(n("googtrans","/en/"+e),location.reload())},s)}function i(){e("googtrans"),e("GOOGTRANS")}document.querySelectorAll(".js-lang-link").forEach(function(e){e.addEventListener("click",function(t){var n=e.getAttribute("data-lang"),s=e.getAttribute("data-has-trans")==="true";if(n==="en"){i();return}s||(t.preventDefault(),o(n))})})}()</script></body></html>