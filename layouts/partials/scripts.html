<div id="google_translate_element" style="display:none"></div>
<script src="https://unpkg.com/feather-icons" defer onload="feather.replace()"></script>

<script>

  // Lazy load AdSense - wait for adsbygoogle to be ready before pushing
  (function() {
    function pushAd(ad, observer) {
      // Ensure adsbygoogle is ready before pushing
      if (typeof window.adsbygoogle === 'undefined' || !window.adsbygoogle.loaded) {
        // Retry after 100ms if adsbygoogle not ready
        setTimeout(function() { pushAd(ad, observer); }, 100);
        return;
      }

      if (ad.offsetWidth > 0 && !ad.dataset.adPushed) {
        try {
          ad.dataset.adPushed = 'true';
          (adsbygoogle = window.adsbygoogle || []).push({});
        } catch (e) {
          console.log('AdSense push error:', e);
        }
        if (observer) observer.unobserve(ad);
      }
    }

    function initLazyAds() {
      var lazyAds = document.querySelectorAll('.lazy-ad:not([data-ad-pushed])');
      if (!lazyAds.length) return;

      if ('IntersectionObserver' in window) {
        var adObserver = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              pushAd(entry.target, adObserver);
            }
          });
        }, {
          rootMargin: '200px 0px',
          threshold: 0
        });

        lazyAds.forEach(function(ad) {
          adObserver.observe(ad);
        });
      } else {
        // Fallback for browsers without IntersectionObserver
        lazyAds.forEach(function(ad) {
          pushAd(ad, null);
        });
      }
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initLazyAds);
    } else {
      initLazyAds();
    }
  })();
  const btn = document.getElementById("scrollToTop");
  const html = document.documentElement;
  const toggleBtn = document.getElementById("theme-toggle");
  const toggleBtnMobile = document.getElementById("theme-toggle-mobile");
  const iconSun = document.getElementById("icon-sun");
  const iconMoon = document.getElementById("icon-moon");
  const iconSunMobile = document.getElementById("icon-sun-mobile");
  const iconMoonMobile = document.getElementById("icon-moon-mobile");

  document.getElementById("menu-toggle")?.addEventListener("click", () => {
    document.getElementById("mobile-menu")?.classList.toggle("hidden");
  });

  btn.style.display = "none";

  window.addEventListener("scroll", () => {
    if (window.scrollY > 300) {
      btn.style.display = "flex";
    } else {
      btn.style.display = "none";
    }
  });

  btn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  function updateIcons(isDark) {
    iconSun.classList.toggle("hidden", !isDark);
    iconMoon.classList.toggle("hidden", isDark);
    iconSunMobile.classList.toggle("hidden", !isDark);
    iconMoonMobile.classList.toggle("hidden", isDark);
  }

  function setDarkMode(isDark) {
    html.setAttribute("data-theme", isDark ? "dark" : "light");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    updateIcons(isDark);
  }

  const userPref = localStorage.getItem("theme");
  const systemPref = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const isDark = userPref === "dark" || (!userPref && systemPref);
  setDarkMode(isDark);

  toggleBtn?.addEventListener("click", () => {
    const currentlyDark = html.getAttribute("data-theme") === "dark";
    setDarkMode(!currentlyDark);
  });
  toggleBtnMobile?.addEventListener("click", () => {
    const currentlyDark = html.getAttribute("data-theme") === "dark";
    setDarkMode(!currentlyDark);
  });

  document.querySelectorAll("pre").forEach((pre) => {
    const button = document.createElement("button");
    button.innerHTML = `
      <span>Copy</span>
    `;
    button.className = `
    copy-btn absolute top-2 right-2
    text-xs px-2 py-1 rounded flex items-center gap-1
    transition-colors duration-200
    bg-gray-200 text-gray-800 hover:bg-gray-300
    dark:bg-white/10 dark:text-white dark:hover:bg-white/20
  `.trim();

    const wrapper = document.createElement("div");
    wrapper.className = "relative";
    pre.parentNode.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);
    wrapper.appendChild(button);

    button.addEventListener("click", () => {
      const code = pre.innerText;
      navigator.clipboard.writeText(code).then(() => {
        button.querySelector("span").innerText = "Copied!";
        setTimeout(() => {
          button.querySelector("span").innerText = "Copy";
        }, 2000);
      });
    });
  });

  const openBtn = document.getElementById("openSearchModal");
  const closeBtn = document.getElementById("closeSearchModal");
  const modal = document.getElementById("searchModal");

  // Lazy load search - only load Fuse.js when search is opened
  let searchInitialized = false;
  let fuse = null;

  function initSearch() {
    if (searchInitialized) return Promise.resolve();

    return new Promise((resolve) => {
      // Load Fuse.js dynamically
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@6.4.6';
      script.onload = () => {
        fetch("/index.json")
          .then((res) => res.json())
          .then((data) => {
            fuse = new Fuse(data, {
              keys: ["title", "summary"],
              threshold: 0.3,
            });
            searchInitialized = true;
            setupSearchHandler();
            resolve();
          });
      };
      document.head.appendChild(script);
    });
  }

  function setupSearchHandler() {
    const searchBox = document.getElementById("searchBox");
    const resultBox = document.getElementById("results");

    searchBox.addEventListener("input", function (e) {
      const query = e.target.value.trim();
      const searchAdBanner = document.getElementById("searchAdBanner");

      if (query.length < 2) {
        resultBox.innerHTML = "";
        if (searchAdBanner) {
          searchAdBanner.classList.remove("show");
          searchAdBanner.classList.add("hide");
          setTimeout(() => searchAdBanner.style.display = "none", 300);
        }
        return;
      }

      if (searchAdBanner) {
        searchAdBanner.style.display = "block";
        searchAdBanner.classList.remove("hide");
        searchAdBanner.classList.add("show");
      }

      const results = fuse.search(query);
      if (results.length === 0) {
        resultBox.innerHTML = `
          <li class='px-4 py-3 text-center text-gray-500 dark:text-gray-400'>
            <div class="mb-2">ðŸ“„ No results found for "${query}"</div>
            <div class="text-xs">Try different keywords or browse categories below</div>
          </li>
        `;
      } else {
        let resultHTML = "";
        results.forEach((r, index) => {
          resultHTML += `
            <li class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
              <a href="${r.item.href}" class="block font-semibold text-gray-900 dark:text-white no-underline">${r.item.title}</a>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${r.item.summary}</p>
            </li>
          `;

          if ((index + 1) % 3 === 0 && index < results.length - 1) {
            resultHTML += `
              <li class="px-4 py-2 bg-blue-50 dark:bg-gray-800 border-l-4 border-blue-400">
                <div class="text-xs text-blue-600 dark:text-blue-400 font-medium">ðŸ“š More related articles</div>
              </li>
            `;
          }
        });
        resultBox.innerHTML = resultHTML;
      }
    });
  }

  openBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    initSearch().then(() => {
      document.getElementById("searchBox").focus();
    });
  });

  closeBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") modal.classList.add("hidden");
  });

    const openBtnMobile = document.getElementById("openSearchModalMobile");

    openBtnMobile.addEventListener("click", () => {
      modal.classList.remove("hidden");
      initSearch().then(() => {
        document.getElementById("searchBox").focus();
      });
    });

  // --- Auto Translate Fallback when translation is missing ---
  (function () {
    function loadGoogleTranslate(cb, onfail) {
      if (window.google && window.google.translate && window.google.translate.TranslateElement) {
        cb && cb();
        return;
      }
      window.__gtReadyCallbacks = window.__gtReadyCallbacks || [];
      if (cb) window.__gtReadyCallbacks.push(cb);
      if (window.__gtLoading) return;
      window.__gtLoading = true;
      window.initGoogleTranslate = function () {
        try {
          new window.google.translate.TranslateElement({
            pageLanguage: 'en',
            includedLanguages: 'id',
            autoDisplay: false,
          }, 'google_translate_element');
        } catch (e) {}
        (window.__gtReadyCallbacks || []).forEach(function (fn) { try { fn(); } catch (e) {} });
        window.__gtReadyCallbacks = [];
      };
      var s = document.createElement('script');
      s.src = 'https://translate.google.com/translate_a/element.js?cb=initGoogleTranslate';
      s.defer = true;
      var failed = false;
      s.onerror = function(){ failed = true; onfail && onfail(); };
      setTimeout(function(){ if(!window.google || !window.google.translate){ failed = true; onfail && onfail(); } }, 4000);
      document.head.appendChild(s);
    }

    function setCookie(name, value) {
      document.cookie = name + '=' + value + '; path=/; expires=' + new Date(Date.now() + 365*24*3600*1000).toUTCString();
    }
    function deleteCookie(name) {
      document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
    }

    function showTranslateFallback() {
      if (document.getElementById('translate-fallback')) return;
      var bar = document.createElement('div');
      bar.id = 'translate-fallback';
      bar.style.cssText = 'position:fixed;bottom:12px;left:50%;transform:translateX(-50%);z-index:9999;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.25);display:flex;gap:10px;align-items:center;';
      bar.innerHTML = '<span style="font-size:13px">Auto-translate tidak tersedia di perangkat ini.</span>' +
        '<button id="btnTryId" style="background:#0ea5e9;color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:12px">Coba versi Indonesia</button>' +
        '<button id="btnCloseTf" style="background:transparent;color:#fff;border:1px solid #fff3;padding:6px 10px;border-radius:8px;font-size:12px">Tutup</button>';
      document.body.appendChild(bar);
      document.getElementById('btnCloseTf').onclick = function(){ bar.remove(); };
      document.getElementById('btnTryId').onclick = function(){
        var idUrl = new URL(location.href);
        var p = location.pathname;
        if (!p.startsWith('/id/')) {
          idUrl.pathname = '/id' + (p.startsWith('/') ? p : '/' + p);
        }
        fetch(idUrl, { method: 'HEAD' }).then(function(r){
          if (r.ok) location.href = idUrl; else location.href = '/id/';
        }).catch(function(){ location.href = '/id/'; });
      };
    }

    function translateTo(lang) {
      loadGoogleTranslate(function () {
        var combo = document.querySelector('.goog-te-combo');
        if (combo) {
          combo.value = lang;
          combo.dispatchEvent(new Event('change'));
        } else {
          // Fallback via cookie if combo not injected yet
          setCookie('googtrans', '/en/' + lang);
          location.reload();
        }
      }, showTranslateFallback);
    }

    function resetTranslate() {
      deleteCookie('googtrans');
      deleteCookie('GOOGTRANS');
    }

    document.querySelectorAll('.js-lang-link').forEach(function (a) {
      a.addEventListener('click', function (e) {
        var lang = a.getAttribute('data-lang');
        var has = a.getAttribute('data-has-trans') === 'true';
        if (lang === 'en') {
          resetTranslate();
          return; // let navigation proceed
        }
        if (!has) {
          e.preventDefault();
          translateTo(lang);
        }
      });
    });
  })();
</script>