{{ define "main" }}

<section class="pt-8 pb-12 bg-gray-50 dark:bg-gray-900">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- ==== LEFT: CONTENT ==== -->
    <div class="lg:col-span-2">

      <!-- FEATURED POST -->
      <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Featured Post</h2>
      {{ $featured := first 1 (where .Site.RegularPages "Params.featured" true) }}
      {{ with index $featured 0 }}
        <a href="{{ .RelPermalink }}" class="block bg-white dark:bg-gray-800 rounded-lg shadow hover:bg-gray-100 dark:hover:bg-gray-700 transition mb-8 overflow-hidden">
          <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-full h-64 object-cover block" loading="eager" fetchpriority="high" />
          <div class="p-6">
            <h3 class="text-2xl font-bold text-[#0f7ea9] mb-2">{{ .Title }}</h3>
            <p class="text-gray-600 dark:text-gray-300 text-base mb-3">
              {{ .Summary | truncate 150 }}
            </p>
            <span class="text-sm text-gray-500 flex items-center gap-1">{{ .Date.Format "Jan 2, 2006" }}</span>
          </div>
        </a>
      {{ end }}

      {{/* AdSense: Mobile banner after featured post */}}
      {{ partial "adsense-mobile-banner.html" . }}

      <!-- TAGS (MOBILE ONLY) -->
      <div class="block lg:hidden mb-10">
        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Tags</h3>
        <div class="flex flex-wrap gap-2">
          {{ $sidebarTags := .Site.Params.sidebarTags }}
          {{ if $sidebarTags }}
            {{ range $tag := $sidebarTags }}
              {{ $key := lower $tag }}
              <a href="{{ "/tags/" | relLangURL }}{{ $key | urlize }}"
                class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-white hover:bg-[#0f7ea9] hover:text-white px-4 py-2 rounded transition min-h-[44px] inline-flex items-center">
                #{{ if eq (lower $tag) "go" }}golang{{ else }}{{ $tag }}{{ end }}
              </a>
            {{ end }}
          {{ else }}
            {{ $min := or .Site.Params.tags.minCount 2 }}
            {{ $max := or .Site.Params.tags.maxSidebar 20 }}
            {{ $.Scratch.Set "shown" 0 }}
            {{ range .Site.Taxonomies.tags.ByCount }}
              {{ if and (ge .Count $min) (lt ($.Scratch.Get "shown") $max) }}
                <a href="{{ "/tags/" | relLangURL }}{{ .Name | urlize }}"
                  class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-white hover:bg-[#0f7ea9] hover:text-white px-4 py-2 rounded transition min-h-[44px] inline-flex items-center">
                  #{{ if eq (lower .Name) "go" }}golang{{ else }}{{ .Name }}{{ end }}
                </a>
                {{ $.Scratch.Add "shown" 1 }}
              {{ end }}
            {{ end }}
          {{ end }}
        </div>
        <div class="mt-3">
          <a href="{{ "/tags/" | relLangURL }}" class="text-sm text-[#0369a1] dark:text-[#38bdf8] hover:underline py-3 px-2 inline-block min-h-[48px]">View all tags →</a>
        </div>
      </div>

      <!-- ARTICLE LIST -->
      <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">
        New Articles
      </h2>
      {{ $pages := sort (where .Site.RegularPages "Type" "blog") "Date" "desc" }}
      {{ $paginator := .Paginate $pages 6 }}
      <div class="grid gap-6 sm:grid-cols-2">
        {{ range $index, $page := $paginator.Pages }}
          <a href="{{ $page.RelPermalink }}"
            class="bg-white dark:bg-gray-800 p-4 rounded shadow hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <h3 class="text-lg font-semibold text-[#0f7ea9] mb-1">{{ $page.Title }}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">{{ $page.Summary | truncate 100 }}</p>
            <span class="text-xs text-gray-500 block mt-2">{{ $page.Date.Format "02 Jan 2006" }}</span>
          </a>
        {{ end }}
      </div>

      <!-- PAGINATION -->
      {{ if gt $paginator.TotalPages 1 }}
        <div class="mt-12 flex justify-center px-2">
          <nav class="flex items-center gap-1 text-sm">
            {{ if $paginator.HasPrev }}
              <a href="{{ $paginator.Prev.URL }}"
                class="px-2 sm:px-3 py-2 text-gray-700 dark:text-white bg-white dark:bg-gray-800 rounded hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 text-xs sm:text-sm">
                <span class="hidden sm:inline">← Prev</span>
                <span class="sm:hidden">←</span>
              </a>
            {{ else }}
              <span class="px-2 sm:px-3 py-2 text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 cursor-not-allowed text-xs sm:text-sm">
                <span class="hidden sm:inline">← Prev</span>
                <span class="sm:hidden">←</span>
              </span>
            {{ end }}

            <!-- Show first page if not in range -->
            {{ if gt $paginator.PageNumber 3 }}
              <a href="{{ (index $paginator.Pagers 0).URL }}" 
                class="px-3 py-2 text-gray-700 dark:text-white bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded border border-gray-300 dark:border-gray-600">
                1
              </a>
              {{ if gt $paginator.PageNumber 4 }}
                <span class="px-2 text-gray-400 dark:text-gray-500">...</span>
              {{ end }}
            {{ end }}

            <!-- Show page numbers around current page -->
            {{ $currentPage := $paginator.PageNumber }}
            {{ $totalPages := $paginator.TotalPages }}
            {{ range $paginator.Pagers }}
              {{ if and (ge .PageNumber (sub $currentPage 2)) (le .PageNumber (add $currentPage 2)) }}
                <a href="{{ .URL }}"
                  class="px-3 py-2 rounded border border-gray-300 dark:border-gray-600
                  {{ if eq . $paginator }}
                    bg-[#0f7ea9] text-white
                  {{ else }}
                    text-gray-700 dark:text-white bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700
                  {{ end }}">
                  {{ .PageNumber }}
                </a>
              {{ end }}
            {{ end }}

            <!-- Show last page if not in range -->
            {{ if lt $paginator.PageNumber (sub $totalPages 2) }}
              {{ if lt $paginator.PageNumber (sub $totalPages 3) }}
                <span class="px-2 text-gray-400 dark:text-gray-500">...</span>
              {{ end }}
              <a href="{{ (index $paginator.Pagers (sub $totalPages 1)).URL }}" 
                class="px-3 py-2 text-gray-700 dark:text-white bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded border border-gray-300 dark:border-gray-600">
                {{ $totalPages }}
              </a>
            {{ end }}

            {{ if $paginator.HasNext }}
              <a href="{{ $paginator.Next.URL }}"
                class="px-2 sm:px-3 py-2 text-gray-700 dark:text-white bg-white dark:bg-gray-800 rounded hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-600 text-xs sm:text-sm">
                <span class="hidden sm:inline">Next →</span>
                <span class="sm:hidden">→</span>
              </a>
            {{ else }}
              <span class="px-2 sm:px-3 py-2 text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 cursor-not-allowed text-xs sm:text-sm">
                <span class="hidden sm:inline">Next →</span>
                <span class="sm:hidden">→</span>
              </span>
            {{ end }}
          </nav>
        </div>
      {{ end }}
    </div>

    <!-- ==== RIGHT: SIDEBAR (DESKTOP ONLY) ==== -->
    <aside class="space-y-10 hidden lg:block">

      <!-- TAGS -->
      <div>
        <h3 class="text-xl font-bold mb-4 pt-[6px] text-gray-900 dark:text-white">Tags</h3>
        <div class="flex flex-wrap gap-2">
          {{/* Prefer curated allowlist from params.sidebarTags; fallback to Top-N by count with min threshold */}}
          {{ $sidebarTags := .Site.Params.sidebarTags }}
          {{ if $sidebarTags }}
            {{ range $tag := $sidebarTags }}
              {{ $key := lower $tag }}
              <a href="{{ "/tags/" | relLangURL }}{{ $key | urlize }}"
                class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-white hover:bg-[#0f7ea9] hover:text-white px-4 py-2 rounded transition min-h-[44px] inline-flex items-center">
                #{{ if eq (lower $tag) "go" }}golang{{ else }}{{ $tag }}{{ end }}
              </a>
            {{ end }}
          {{ else }}
            {{ $min := or .Site.Params.tags.minCount 2 }}
            {{ $max := or .Site.Params.tags.maxSidebar 20 }}
            {{ $.Scratch.Set "shown" 0 }}
            {{ range .Site.Taxonomies.tags.ByCount }}
              {{ if and (ge .Count $min) (lt ($.Scratch.Get "shown") $max) }}
                <a href="{{ "/tags/" | relLangURL }}{{ .Name | urlize }}"
                  class="text-sm bg-gray-200 dark:bg-gray-700 dark:text-white hover:bg-[#0f7ea9] hover:text-white px-4 py-2 rounded transition min-h-[44px] inline-flex items-center">
                  #{{ if eq (lower .Name) "go" }}golang{{ else }}{{ .Name }}{{ end }}
                </a>
                {{ $.Scratch.Add "shown" 1 }}
              {{ end }}
            {{ end }}
          {{ end }}
        </div>
        <div class="mt-3">
          <a href="{{ "/tags/" | relLangURL }}" class="text-sm text-[#0369a1] dark:text-[#38bdf8] hover:underline py-3 px-2 inline-block min-h-[48px]">View all tags →</a>
        </div>
      </div>

      <!-- ADS: Sidebar (desktop only) -->
      {{ partial "adsense-sidebar-300x250.html" . }}

    </aside>

  </div>
</section>

{{ end }}
